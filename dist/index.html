
  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      :root {
        --bg-color: #121212;
        --container-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --heading-color: #ffffff;
        --subheading-color: #58a6ff;
        --link-color: #58a6ff;
        --border-color: #333333;
        --item-hover: #2a2a2a;
        --shadow: 0 4px 12px rgba(0,0,0,0.2);
        --accent-color: #58a6ff;
        --tooltip-bg: #2a2a2a;
        --tooltip-text: #e0e0e0;
        --table-header-bg: #2a2a2a;
        --table-header-text: #ffffff;
        --table-row-odd: #1e1e1e;
        --table-row-even: #252525;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        line-height: 1.5;
        color: var(--text-color);
        background-color: var(--bg-color);
        margin: 0;
        padding: 0;
      }
      
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 15px;
      }
      
      .card {
        background-color: var(--container-bg);
        border-radius: 8px;
        box-shadow: var(--shadow);
        padding: 16px;
        margin-bottom: 16px;
        transition: all 0.2s ease;
      }
      
      .card:hover {
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      }

      .header-p {
        margin: 0.2em 0;
        font-weight: 500;
        letter-spacing: -0.02em;
        font-size: 14px;
      }

      .subreddit {
        text-align: right;
      }
      
      h2 {
        font-size: 18px;
        font-weight: 600;
        color: var(--heading-color);
        margin-top: 0;
        margin-bottom: 12px;
        padding-bottom: 6px;
        border-bottom: 2px solid var(--accent-color);
      }
      
      h3 {
        font-size: 16px;
        font-weight: 500;
        color: var(--subheading-color);
        margin-bottom: 8px;
      }
      
      a {
        color: var(--link-color);
        text-decoration: none;
        transition: color 0.2s ease;
      }
      
      a:hover {
        color: var(--accent-color);
        text-decoration: underline;
      }
      
      /* Weather Table Styles */
      .weather-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        border-radius: 6px;
        overflow: hidden;
      }
      
      .weather-table th {
        background-color: var(--table-header-bg);
        color: var(--table-header-text);
        font-weight: 500;
        text-align: left;
        padding: 8px 12px;
        font-size: 14px;
      }
      
      .weather-table td {
        padding: 8px 12px;
        border-bottom: 1px solid var(--border-color);
        font-size: 14px;
      }
      
      .weather-table tr:nth-child(odd) {
        background-color: var(--table-row-odd);
      }
      
      .weather-table tr:nth-child(even) {
        background-color: var(--table-row-even);
      }
      
      .weather-table tr:last-child td {
        border-bottom: none;
      }
      
      .comic {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 12px 0;
      }
      
      .comic-title {
        font-weight: 600;
        margin-bottom: 8px;
        text-align: center;
        font-size: 15px;
      }
      
      .comic img {
        max-width: 600px;
        max-height: auto;
        object-fit: contain;
        border-radius: 6px;
        margin-bottom: 6px;
        cursor: pointer;
      }
      
      .comic-number {
        font-size: 12px;
        color: var(--text-color);
        opacity: 0.7;
        margin-top: 3px;
      }
      
      .item-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      
      .item-list li {
        padding: 8px 10px;
        border-bottom: 1px solid var(--border-color);
        position: relative;
        font-size: 14px;
      }
      
      .item-list li:last-child {
        border-bottom: none;
      }
      
      .item-list li:hover {
        background-color: var(--item-hover);
        border-radius: 4px;
      }
      
      .item-content {
        display: none;
        position: absolute;
        z-index: 10;
        background-color: var(--tooltip-bg);
        color: var(--tooltip-text);
        border-radius: 6px;
        padding: 15px;
        width: 90%;
        max-width: 100%;
        box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        left: 50%;
        transform: translateX(-50%);
        bottom: 100%;
        font-size: 13px;
        line-height: 1.4;
        overflow: auto;
        max-height: 250px;
        border: 4px solid var(--border-color);
      }

      .item-content::-webkit-scrollbar {
        display: none;
      }

      .item-list li:hover .item-content {
        display: block;
      }
      
      .item-list li::before {
        content: "‚Ä¢";
        color: var(--accent-color);
        font-weight: bold;
        display: inline-block;
        width: 1em;
        margin-left: -0.5em;
      }
      
      @media (max-width: 600px) {
        .container {
          padding: 10px;
        }
        
        .card {
          padding: 12px;
          margin-bottom: 12px;
        }
        
        .item-content {
          width: 95%;
          left: 2.5%;
          transform: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
  
      <div class="card">
        <h2>Huginn Daily</h2>
        <p class="header-p">Saturday, June 28, 2025</p>
        <p class="header-p">aa48afbc-942b-4ba8-8c10-505987f12529</p>
      </div>
  
      <div class="card">
        <h2>Weather</h2>
        <table class="weather-table">
          <tr>
            <th>Summary</th>
            <td>‚õÖÔ∏è Clear throughout the day.</td>
          </tr>
          <tr>
            <th>Temperature Range</th>
            <td>24¬∞C to 34¬∞C (76¬∞F to 93¬∞F)</td>
          </tr>
          <tr>
            <th>Feels Like</th>
            <td>Low: 71¬∞F | High: 89¬∞F</td>
          </tr>
          <tr>
            <th>Humidity</th>
            <td>35%</td>
          </tr>
          <tr>
            <th>Wind</th>
            <td>11 km/h (7 mph), Direction: 186¬∞</td>
          </tr>
          <tr>
            <th>Precipitation</th>
            <td>Probability: 0%, Type: No precipitation expected</td>
          </tr>
          <tr>
            <th>Sunrise / Sunset</th>
            <td>üåÖ 05:37 AM / üåá 08:04 PM</td>
          </tr>
          <tr>
            <th>Moon Phase</th>
            <td>Waxing Crescent (11%)</td>
          </tr>
          <tr>
            <th>Cloud Cover</th>
            <td>0%</td>
          </tr>
          <tr>
            <th>Pressure</th>
            <td>1002.78 hPa</td>
          </tr>
          <tr>
            <th>Dew Point</th>
            <td>53.12¬∞F</td>
          </tr>
          <tr>
            <th>Visibility</th>
            <td>10.0 miles</td>
          </tr>
        </table>
      </div>
  
      <div class="card">
        <h2>XKCD</h2>
  
        <div class="comic">
          <a href="//imgs.xkcd.com/comics/laser_danger.png" target="_blank">
            <img src="//imgs.xkcd.com/comics/laser_danger.png" alt="Laser Danger">
          </a>
        </div>
  
      </div>
  
      <div class="card">
        <h2>Other</h2>
        <ul class="item-list">
  
          <li>
            <a href="https://selfh.st/weekly/2025-06-27/" target="_blank"> Self-Host Weekly (27 June 2025) </a>
            <div class="item-content">
		    Self-hosted news, updates, launches, and content for the week ending Friday, June 27, 2025
		    <br>
		    <a href="https://selfh.st/weekly/2025-06-27/">Continue reading on selfh.st...</a>
		  </div>
          </li>
  
        </ul>
      </div>
  
      <div class="card">
        <h2>Golang</h2>
        <ul class="item-list">
  
          <li>
            <a href="https://go.dev/blog/testing-b-loop" target="_blank">More predictable benchmarking with testing.B.Loop</a>
            <div class="item-content">
<div id="blog"><div id="content">
  <div id="content">

    <div class="Article" data-slug="/blog/testing-b-loop">
    
    <h1 class="small"><a href="/blog/">The Go Blog</a></h1>
    

    <h1>More predictable benchmarking with testing.B.Loop</h1>
      
      <p class="author">
      Junyang Shao<br>
      2 April 2025
      </p>
      
      <p>Go developers who have written benchmarks using the
<a href="https://pkg.go.dev/testing" rel="noreferrer" target="_blank"><code>testing</code></a> package might have encountered some of
its various pitfalls. Go 1.24 introduces a new way to write benchmarks that&rsquo;s just
as easy to use, but at the same time far more robust:
<a href="https://pkg.go.dev/testing#B.Loop" rel="noreferrer" target="_blank"><code>testing.B.Loop</code></a>.</p>
<p>Traditionally, Go benchmarks are written using a loop from 0 to <code>b.N</code>:</p>
<pre><code>func Benchmark(b *testing.B) {
  for range b.N {
    ... code to measure ...
  }
}
</code></pre>
<p>Using <code>b.Loop</code> instead is a trivial change:</p>
<pre><code>func Benchmark(b *testing.B) {
  for b.Loop() {
    ... code to measure ...
  }
}
</code></pre>
<p><code>testing.B.Loop</code> has many benefits:</p>
<ul>
<li>It prevents unwanted compiler optimizations within the benchmark loop.</li>
<li>It automatically excludes setup and cleanup code from benchmark timing.</li>
<li>Code can&rsquo;t accidentally depend on the total number of iterations or the current
iteration.</li>
</ul>
<p>These were all easy mistakes to make with <code>b.N</code>-style benchmarks that would
silently result in bogus benchmark results. As an added bonus, <code>b.Loop</code>-style
benchmarks even complete in less time!</p>
<p>Let&rsquo;s explore the advantages of <code>testing.B.Loop</code> and how to effectively utilize it.</p>
<h2 id="old-benchmark-loop-problems">Old benchmark loop problems</h2>
<p>Before Go 1.24, while the basic structure of a benchmark was simple, more sophisticated
benchmarks required more care:</p>
<pre><code>func Benchmark(b *testing.B) {
  ... setup ...
  b.ResetTimer() // if setup may be expensive
  for range b.N {
    ... code to measure ...
    ... use sinks or accumulation to prevent dead-code elimination ...
  }
  b.StopTimer() // if cleanup or reporting may be expensive
  ... cleanup ...
  ... report ...
}
</code></pre>
<p>If setup or cleanup are non-trivial, the developer needs to surround the benchmark loop
with <code>ResetTimer</code> and/or <code>StopTimer</code> calls. These are easy to forget, and even if the
developer remembers they may be necessary, it can be difficult to judge whether setup or
cleanup are &ldquo;expensive enough&rdquo; to require them.</p>
<p>Without these, the <code>testing</code> package can only time the entire benchmark function. If a
benchmark function omits them, the setup and cleanup code will be included in the overall
time measurement, silently skewing the final benchmark result.</p>
<p>There is another, more subtle pitfall that requires deeper understanding:
(<a href="https://eli.thegreenplace.net/2023/common-pitfalls-in-go-benchmarking/" rel="noreferrer" target="_blank">Example source</a>)</p>
<pre><code>func isCond(b byte) bool {
  if b%3 == 1 &amp;&amp; b%7 == 2 &amp;&amp; b%17 == 11 &amp;&amp; b%31 == 9 {
    return true
  }
  return false
}

func BenchmarkIsCondWrong(b *testing.B) {
  for range b.N {
    isCond(201)
  }
}
</code></pre>
<p>In this example, the user might observe <code>isCond</code> executing in sub-nanosecond
time. CPUs are fast, but not that fast! This seemingly anomalous result stems
from the fact that <code>isCond</code> is inlined, and since its result is never used, the
compiler eliminates it as dead code. As a result, this benchmark doesn&rsquo;t measure <code>isCond</code>
at all; it measures how long it takes to do nothing. In this case, the sub-nanosecond
result is a clear red flag, but in more complex benchmarks, partial dead-code elimination
can lead to results that look reasonable but still aren&rsquo;t measuring what was intended.</p>
<h2 id="how-testingbloop-helps">How <code>testing.B.Loop</code> helps</h2>
<p>Unlike a <code>b.N</code>-style benchmark, <code>testing.B.Loop</code> is able to track when it is first called
in a benchmark when the final iteration ends. The <code>b.ResetTimer</code> at the loop&rsquo;s start
and <code>b.StopTimer</code> at its end are integrated into <code>testing.B.Loop</code>, eliminating the need
to manually manage the benchmark timer for setup and cleanup code.</p>
<p>Furthermore, the Go compiler now detects loops where the condition is just a call to
<code>testing.B.Loop</code> and prevents dead code elimination within the loop. In Go 1.24, this is
implemented by disallowing inlining into the body of such a loop, but we plan to
<a href="/issue/73137">improve</a> this in the future.</p>
<p>Another nice feature of <code>testing.B.Loop</code> is its one-shot ramp-up approach. With a <code>b.N</code>-style
benchmark, the testing package must call the benchmark function several times with different
values of <code>b.N</code>, ramping up until the measured time reached a threshold. In contrast, <code>b.Loop</code>
can simply run the benchmark loop until it reaches the time threshold, and only needs to call
the benchmark function once. Internally, <code>b.Loop</code> still uses a ramp-up process to amortize
measurement overhead, but this is hidden from the caller and can be more efficient.</p>
<p>Certain constraints of the <code>b.N</code>-style loop still apply to the <code>b.Loop</code>-style
loop. It remains the user&rsquo;s responsibility to manage the timer within the benchmark loop,
when necessary:
(<a href="https://eli.thegreenplace.net/2023/common-pitfalls-in-go-benchmarking/" rel="noreferrer" target="_blank">Example source</a>)</p>
<pre><code>func BenchmarkSortInts(b *testing.B) {
  ints := make([]int, N)
  for b.Loop() {
    b.StopTimer()
    fillRandomInts(ints)
    b.StartTimer()
    slices.Sort(ints)
  }
}
</code></pre>
<p>In this example, to benchmark the in-place sorting performance of <code>slices.Sort</code>, a
randomly initialized array is required for each iteration. The user must still
manually manage the timer in such cases.</p>
<p>Furthermore, there still needs to be exactly one such loop in the benchmark function body
(a <code>b.N</code>-style loop cannot coexist with a <code>b.Loop</code>-style loop), and every iteration of the
loop should do the same thing.</p>
<h2 id="when-to-use">When to use</h2>
<p>The <code>testing.B.Loop</code> method is now the preferred way to write benchmarks:</p>
<pre><code>func Benchmark(b *testing.B) {
  ... setup ...
  for b.Loop() {
    // optional timer control for in-loop setup/cleanup
    ... code to measure ...
  }
  ... cleanup ...
}
</code></pre>
<p><code>testing.B.Loop</code> offers faster, more accurate, and
more intuitive benchmarking.</p>
<h2 id="acknowledgements">Acknowledgements</h2>
<p>A huge thank you to everyone in the community who provided feedback on the proposal
issue and reported bugs as this feature was released! I&rsquo;m also grateful to Eli
Bendersky for his helpful blog summaries. And finally a big thank you to Austin Clements,
Cherry Mui and Michael Pratt for their review, thoughtful work on the design options and
documentation improvements. Thank you all for your contributions!</p>

    </div>

    
    <div class="Article prevnext">
    
    
      
    
      
    
      
        <p>
        
          
            <b>Next article: </b><a href="/blog/tob-crypto-audit">Go Cryptography Security Audit</a><br>
          
        
        
          
            <b>Previous article: </b><a href="/blog/coretypes">Goodbye core types - Hello Go as we know and love it!</a><br>
          
        
        <b><a href="/blog/all">Blog Index</a></b>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    </div>
    

  </div>
</div>

<script src="/js/play.js"></script>

</div>
          </li>
  
          <li>
            <a href="https://go.dev/blog/coretypes" target="_blank">Goodbye core types - Hello Go as we know and love it!</a>
            <div class="item-content">
<div id="blog"><div id="content">
  <div id="content">

    <div class="Article" data-slug="/blog/coretypes">
    
    <h1 class="small"><a href="/blog/">The Go Blog</a></h1>
    

    <h1>Goodbye core types - Hello Go as we know and love it!</h1>
      
      <p class="author">
      Robert Griesemer<br>
      26 March 2025
      </p>
      
      <p>The Go 1.18 release introduced generics and with that a number of new features, including type parameters, type constraints, and new concepts such as type sets.
It also introduced the notion of a <em>core type</em>.
While the former provide concrete new functionality, a core type is an abstract construct that was introduced
for expediency and to simplify dealing with generic operands (operands whose types are type parameters).
In the Go compiler, code that in the past relied on the <a href="/ref/spec/#Underlying_types">underlying type</a> of an operand,
now instead had to call a function computing the operand&rsquo;s core type.
In the language spec, in many places we just needed to replace &ldquo;underlying type&rdquo; with &ldquo;core type&rdquo;.
What&rsquo;s not to like?</p>
<p>Quite a few things, as it turns out!
To understand how we got here, it&rsquo;s useful to briefly revisit how type parameters and type constraints work.</p>
<h2 id="type-parameters-and-type-constraints">Type parameters and type constraints</h2>
<p>A type parameter is a placeholder for a future type argument;
it acts like a <em>type variable</em> whose value is known at compile time,
similar to how a named constant stands for a number, string, or bool whose value is known at compile time.
Like ordinary variables, type parameters have a type.
That type is described by their <em>type constraint</em> which determines
what operations are permitted on operands whose type is the respective type parameter.</p>
<p>Any concrete type that instantiates a type parameter must satisfy the type parameter&rsquo;s constraint.
This ensures that an operand whose type is a type parameter possesses all of the respective type constraint&rsquo;s properties,
no matter what concrete type is used to instantiate the type parameter.</p>
<p>In Go, type constraints are described through a mixture of method and type requirements which together
define a <em>type set</em>: this is the set of all the types that satisfy all the requirements. Go uses a
generalized form of interfaces for this purpose. An interface enumerates a set of methods and types,
and the type set described by such an interface consists of all the types that implement those methods
and that are included in the enumerated types.</p>
<p>For instance, the type set described by the interface</p>
<pre><code class="language-Go">type Constraint interface {
    ~[]byte | ~string
    Hash() uint64
}
</code></pre>
<p>consists of all the types whose representation is <code>[]byte</code> or <code>string</code> and whose method set includes the <code>Hash</code> method.</p>
<p>With this we can now write down the rules that govern operations on generic operands.
For instance, the <a href="/ref/spec#Index_expressions">rules for index expressions</a> state that (among other things)
for an operand <code>a</code> of type parameter type <code>P</code>:</p>
<blockquote>
<p>The index expression <code>a[x]</code> must be valid for values of all types in <code>P</code>&rsquo;s type set.
The element types of all types in <code>P</code>&rsquo;s type set must be identical.
(In this context, the element type of a string type is <code>byte</code>.)</p>
</blockquote>
<p>These rules make it possible to index the generic variable <code>s</code> below (<a href="/play/p/M1LYKm3x3IB">playground</a>):</p>
<pre><code class="language-Go">func at[bytestring Constraint](s bytestring, i int) byte {
    return s[i]
}
</code></pre>
<p>The indexing operation <code>s[i]</code> is permitted because the type of <code>s</code> is <code>bytestring</code>, and the type constraint (type set) of
<code>bytestring</code> contains <code>[]byte</code> and <code>string</code> types for which indexing with <code>i</code> is valid.</p>
<h2 id="core-types">Core types</h2>
<p>This type set-based approach is very flexible and in line with the intentions of the
<a href="https://go.googlesource.com/proposal/+/refs/heads/master/design/43651-type-parameters.md" rel="noreferrer" target="_blank">original generics proposal</a>:
an operation involving operands of generic type should be valid if it is valid for any type permitted by the respective
type constraint.
To simplify matters with respect to the implementation, knowing that we would be able to relax rules later,
this approach was <em>not</em> chosen universally.
Instead, for instance, for <a href="/ref/spec#Send_statements">Send statements</a>, the spec states that</p>
<blockquote>
<p>The channel expression&rsquo;s <em>core type</em> must be a channel, the channel direction must permit send operations,
and the type of the value to be sent must be assignable to the channel&rsquo;s element type.</p>
</blockquote>
<p>These rules are based on the notion of a core type which is defined roughly as follows:</p>
<ul>
<li>If a type is not a type parameter, its core type is just its <a href="/ref/spec#Underlying_types">underlying type</a>.</li>
<li>If the type is a type parameter, the core type is the single underlying type of all the types in the type parameter&rsquo;s type set.
If the type set has <em>different</em> underlying types, the core type doesn&rsquo;t exist.</li>
</ul>
<p>For instance, <code>interface{ ~[]int }</code> has a core type (<code>[]int</code>), but the <code>Constraint</code> interface above does not have a core type.
To make things more complicated, when it comes to channel operations and certain built-in calls (<code>append</code>, <code>copy</code>) the above definition
of core types is too restrictive.
The actual rules have adjustments that allow for differing channel directions and type sets containing both <code>[]byte</code> and <code>string</code> types.</p>
<p>There are various problems with this approach:</p>
<ul>
<li>
<p>Because the definition of core type must lead to sound type rules for different language features,
it is overly restrictive for specific operations.
For instance, the Go 1.24 rules for <a href="/ref/spec#Slice_expressions">slice expressions</a> do rely on core types,
and as a consequence slicing an operand of type <code>S</code> constrained by <code>Constraint</code> is not permitted, even though
it could be valid.</p>
</li>
<li>
<p>When trying to understand a specific language feature, one may have to learn the intricacies of
core types even when considering non-generic code.
Again, for slice expressions, the language spec talks about the core type of the sliced operand,
rather than just stating that the operand must be an array, slice, or string.
The latter is more direct, simpler, and clearer, and doesn&rsquo;t require knowing another concept that may be
irrelevant in the concrete case.</p>
</li>
<li>
<p>Because the notion of core types exists, the rules for index expressions, and <code>len</code> and <code>cap</code> (and others),
which all eschew core types, appear as exceptions in the language rather than the norm.
In turn, core types cause proposals such as <a href="/issue/48522">issue #48522</a> which would permit a selector
<code>x.f</code> to access a field <code>f</code> shared by all elements of <code>x</code>&rsquo;s type set, to appear to add more exceptions to the
language.
Without core types, that feature becomes a natural and useful consequence of the ordinary rules for non-generic
field access.</p>
</li>
</ul>
<h2 id="go-125">Go 1.25</h2>
<p>For the upcoming Go 1.25 release (August 2025) we decided to remove the notion of core types from the
language spec in favor of explicit (and equivalent!) prose where needed.
This has multiple benefits:</p>
<ul>
<li>The Go spec presents fewer concepts, making it easier to learn the language.</li>
<li>The behavior of non-generic code can be understood without reference to generics concepts.</li>
<li>The individualized approach (specific rules for specific operations) opens the door for more flexible rules.
We already mentioned <a href="/issue/48522">issue #48522</a>, but there are also ideas for more powerful
slice operations, and <a href="/issue/69153">improved type inference</a>.</li>
</ul>
<p>The respective <a href="/issue/70128">proposal issue #70128</a> was recently approved and the relevant changes
are already implemented.
Concretely this means that a lot of prose in the language spec was reverted to its original,
pre-generics form, and new paragraphs were added where needed to explain the rules as they
pertain to generic operands. Importantly, no behavior was changed.
The entire section on core types was removed.
The compiler&rsquo;s error messages were updated to not mention &ldquo;core type&rdquo; anymore, and in many
cases error messages are now more specific by pointing out exactly which type in a type set
is causing a problem.</p>
<p>Here is a sample of the changes made. For the built-in function <code>close</code>,
starting with Go 1.18 the spec began as follows:</p>
<blockquote>
<p>For an argument <code>ch</code> with core type that is a channel,
the built-in function <code>close</code> records that no more values will be sent on the channel.</p>
</blockquote>
<p>A reader who simply wanted to know how <code>close</code> works, had to first learn about core types.
Starting with Go 1.25, this section will again begin the same way it began before Go 1.18:</p>
<blockquote>
<p>For a channel <code>ch</code>, the built-in function <code>close(ch)</code>
records that no more values will be sent on the channel.</p>
</blockquote>
<p>This is shorter and easier to understand.
Only when the reader is dealing with a generic operand will they have to contemplate
the newly added paragraph:</p>
<blockquote>
<p>If the type of the argument to <code>close</code> is a type parameter
all types in its type set must be channels with the same element type.
It is an error if any of those channels is a receive-only channel.</p>
</blockquote>
<p>We made similar changes to each place that mentioned core types.
In summary, although this spec update does not affect any current Go program, it opens the
door to future language improvements while making the language as it is today easier to
learn and its spec simpler.</p>

    </div>

    
    <div class="Article prevnext">
    
    
      
    
      
    
      
    
      
        <p>
        
          
            <b>Next article: </b><a href="/blog/testing-b-loop">More predictable benchmarking with testing.B.Loop</a><br>
          
        
        
          
            <b>Previous article: </b><a href="/blog/osroot">Traversal-resistant file APIs</a><br>
          
        
        <b><a href="/blog/all">Blog Index</a></b>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    </div>
    

  </div>
</div>

<script src="/js/play.js"></script>

</div>
          </li>
  
          <li>
            <a href="https://go.dev/blog/osroot" target="_blank">Traversal-resistant file APIs</a>
            <div class="item-content">
<div id="blog"><div id="content">
  <div id="content">

    <div class="Article" data-slug="/blog/osroot">
    
    <h1 class="small"><a href="/blog/">The Go Blog</a></h1>
    

    <h1>Traversal-resistant file APIs</h1>
      
      <p class="author">
      Damien Neil<br>
      12 March 2025
      </p>
      
      <p>A <em>path traversal vulnerability</em> arises when an attacker can trick a program
into opening a file other than the one it intended.
This post explains this class of vulnerability,
some existing defenses against it, and describes how the new
<a href="/pkg/os#Root"><code>os.Root</code></a> API added in Go 1.24 provides
a simple and robust defense against unintentional path traversal.</p>
<h2 id="path-traversal-attacks">Path traversal attacks</h2>
<p>&ldquo;Path traversal&rdquo; covers a number of related attacks following a common pattern:
A program attempts to open a file in some known location, but an attacker causes
it to open a file in a different location.</p>
<p>If the attacker controls part of the filename, they may be able to use relative
directory components (&quot;..&quot;) to escape the intended location:</p>
<pre><code>f, err := os.Open(filepath.Join(trustedLocation, &quot;../../../../etc/passwd&quot;))
</code></pre>
<p>On Windows systems, some names have special meaning:</p>
<pre><code>// f will print to the console.
f, err := os.Create(filepath.Join(trustedLocation, &quot;CONOUT$&quot;))
</code></pre>
<p>If the attacker controls part of the local filesystem, they may be able to use
symbolic links to cause a program to access the wrong file:</p>
<pre><code>// Attacker links /home/user/.config to /home/otheruser/.config:
err := os.WriteFile(&quot;/home/user/.config/foo&quot;, config, 0o666)
</code></pre>
<p>If the program defends against symlink traversal by first verifying that the intended file
does not contain any symlinks, it may still be vulnerable to
<a href="https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use" rel="noreferrer" target="_blank">time-of-check/time-of-use (TOCTOU) races</a>,
where the attacker creates a symlink after the program&rsquo;s check:</p>
<pre><code>// Validate the path before use.
cleaned, err := filepath.EvalSymlinks(unsafePath)
if err != nil {
  return err
}
if !filepath.IsLocal(cleaned) {
  return errors.New(&quot;unsafe path&quot;)
}

// Attacker replaces part of the path with a symlink.
// The Open call follows the symlink:
f, err := os.Open(cleaned)
</code></pre>
<p>Another variety of TOCTOU race involves moving a directory that forms part of a path
mid-traversal. For example, the attacker provides a path such as &ldquo;a/b/c/../../etc/passwd&rdquo;,
and renames &ldquo;a/b/c&rdquo; to &ldquo;a/b&rdquo; while the open operation is in progress.</p>
<h2 id="path-sanitization">Path sanitization</h2>
<p>Before we tackle path traversal attacks in general, let&rsquo;s start with path sanitization.
When a program&rsquo;s threat model does not include attackers with access to the local file system,
it can be sufficient to validate untrusted input paths before use.</p>
<p>Unfortunately, sanitizing paths can be surprisingly tricky,
especially for portable programs that must handle both Unix and Windows paths.
For example, on Windows <code>filepath.IsAbs(`\foo`)</code> reports <code>false</code>,
because the path &ldquo;\foo&rdquo; is relative to the current drive.</p>
<p>In Go 1.20, we added the <a href="/pkg/path/filepath#IsLocal"><code>path/filepath.IsLocal</code></a>
function, which reports whether a path is &ldquo;local&rdquo;. A &ldquo;local&rdquo; path is one which:</p>
<ul>
<li>does not escape the directory in which it is evaluated (&quot;../etc/passwd&quot; is not allowed);</li>
<li>is not an absolute path (&quot;/etc/passwd&quot; is not allowed);</li>
<li>is not empty (&quot;&quot; is not allowed);</li>
<li>on Windows, is not a reserved name (&ldquo;COM1&rdquo; is not allowed).</li>
</ul>
<p>In Go 1.23, we added the <a href="/pkg/path/filepath#Localize"><code>path/filepath.Localize</code></a>
function, which converts a /-separated path into a local operating system path.</p>
<p>Programs that accept and operate on potentially attacker-controlled paths should almost
always use <code>filepath.IsLocal</code> or <code>filepath.Localize</code> to validate or sanitize those paths.</p>
<h2 id="beyond-sanitization">Beyond sanitization</h2>
<p>Path sanitization is not sufficient when attackers may have access to part of
the local filesystem.</p>
<p>Multi-user systems are uncommon these days, but attacker access to the filesystem
can still occur in a variety of ways.
An unarchiving utility that extracts a tar or zip file may be induced
to extract a symbolic link and then extract a file name that traverses that link.
A container runtime may give untrusted code access to a portion of the local filesystem.</p>
<p>Programs may defend against unintended symlink traversal by using the
<a href="/pkg/path/filepath#EvalSymlinks"><code>path/filepath.EvalSymlinks</code></a>
function to resolve links in untrusted names before validation, but as described
above this two-step process is vulnerable to TOCTOU races.</p>
<p>Before Go 1.24, the safer option was to use a package such as
<a href="/pkg/github.com/google/safeopen">github.com/google/safeopen</a>,
that provides path traversal-resistant functions for opening a potentially-untrusted
filename within a specific directory.</p>
<h2 id="introducing-osroot">Introducing <code>os.Root</code></h2>
<p>In Go 1.24, we are introducing new APIs in the <code>os</code> package to safely open
a file in a location in a traversal-resistant fashion.</p>
<p>The new <a href="/pkg/os#Root"><code>os.Root</code></a> type represents a directory somewhere
in the local filesystem. Open a root with the <a href="/pkg/os#OpenRoot"><code>os.OpenRoot</code></a>
function:</p>
<pre><code>root, err := os.OpenRoot(&quot;/some/root/directory&quot;)
if err != nil {
  return err
}
defer root.Close()
</code></pre>
<p><code>Root</code> provides methods to operate on files within the root.
These methods all accept filenames relative to the root,
and disallow any operations that would escape from the root either
using relative path components (&quot;..&quot;) or symlinks.</p>
<pre><code>f, err := root.Open(&quot;path/to/file&quot;)
</code></pre>
<p><code>Root</code> permits relative path components and symlinks that do not escape the root.
For example, <code>root.Open(&quot;a/../b&quot;)</code> is permitted. Filenames are resolved using the
semantics of the local platform: On Unix systems, this will follow
any symlink in &ldquo;a&rdquo; (so long as that link does not escape the root);
while on Windows systems this will open &ldquo;b&rdquo; (even if &ldquo;a&rdquo; does not exist).</p>
<p><code>Root</code> currently provides the following set of operations:</p>
<pre><code>func (*Root) Create(string) (*File, error)
func (*Root) Lstat(string) (fs.FileInfo, error)
func (*Root) Mkdir(string, fs.FileMode) error
func (*Root) Open(string) (*File, error)
func (*Root) OpenFile(string, int, fs.FileMode) (*File, error)
func (*Root) OpenRoot(string) (*Root, error)
func (*Root) Remove(string) error
func (*Root) Stat(string) (fs.FileInfo, error)
</code></pre>
<p>In addition to the <code>Root</code> type, the new
<a href="/pkg/os#OpenInRoot"><code>os.OpenInRoot</code></a> function
provides a simple way to open a potentially-untrusted filename within a
specific directory:</p>
<pre><code>f, err := os.OpenInRoot(&quot;/some/root/directory&quot;, untrustedFilename)
</code></pre>
<p>The <code>Root</code> type provides a simple, safe, portable API for operating with untrusted filenames.</p>
<h2 id="caveats-and-considerations">Caveats and considerations</h2>
<h3 id="unix">Unix</h3>
<p>On Unix systems, <code>Root</code> is implemented using the <code>openat</code> family of system calls.
A <code>Root</code> contains a file descriptor referencing its root directory and will track that
directory across renames or deletion.</p>
<p><code>Root</code> defends against symlink traversal but does not limit traversal
of mount points. For example, <code>Root</code> does not prevent traversal of
Linux bind mounts. Our threat model is that <code>Root</code> defends against
filesystem constructs that may be created by ordinary users (such
as symlinks), but does not handle ones that require root privileges
to create (such as bind mounts).</p>
<h3 id="windows">Windows</h3>
<p>On Windows, <code>Root</code> opens a handle referencing its root directory.
The open handle prevents that directory from being renamed or deleted until the <code>Root</code> is closed.</p>
<p><code>Root</code> prevents access to reserved Windows device names such as <code>NUL</code> and <code>COM1</code>.</p>
<h3 id="wasi">WASI</h3>
<p>On WASI, the <code>os</code> package uses the WASI preview 1 filesystem API,
which are intended to provide traversal-resistant filesystem access.
Not all WASI implementations fully support filesystem sandboxing,
however, and <code>Root</code>&rsquo;s defense against traversal is limited to that provided
by the WASI implementation.</p>
<h3 id="goosjs">GOOS=js</h3>
<p>When GOOS=js, the <code>os</code> package uses the Node.js file system API.
This API does not include the openat family of functions,
and so <code>os.Root</code> is vulnerable to TOCTOU (time-of-check-time-of-use) races in symlink
validation on this platform.</p>
<p>When GOOS=js, a <code>Root</code> references a directory name rather than a file descriptor,
and does not track directories across renames.</p>
<h3 id="plan-9">Plan 9</h3>
<p>Plan 9 does not have symlinks.
On Plan 9, a <code>Root</code> references a directory name and performs lexical sanitization of
filenames.</p>
<h3 id="performance">Performance</h3>
<p><code>Root</code> operations on filenames containing many directory components can be much more expensive
than the equivalent non-<code>Root</code> operation. Resolving &ldquo;..&rdquo; components can also be expensive.
Programs that want to limit the cost of filesystem operations can use <code>filepath.Clean</code> to
remove &ldquo;..&rdquo; components from input filenames, and may want to limit the number of
directory components.</p>
<h2 id="who-should-use-osroot">Who should use os.Root?</h2>
<p>You should use <code>os.Root</code> or <code>os.OpenInRoot</code> if:</p>
<ul>
<li>you are opening a file in a directory; AND</li>
<li>the operation should not access a file outside that directory.</li>
</ul>
<p>For example, an archive extractor writing files to an output directory should use
<code>os.Root</code>, because the filenames are potentially untrusted and it would be incorrect
to write a file outside the output directory.</p>
<p>However, a command-line program that writes output to a user-specified location
should not use <code>os.Root</code>, because the filename is not untrusted and may
refer to anywhere on the filesystem.</p>
<p>As a good rule of thumb, code which calls <code>filepath.Join</code> to combine a fixed directory
and an externally-provided filename should probably use <code>os.Root</code> instead.</p>
<pre><code>// This might open a file not located in baseDirectory.
f, err := os.Open(filepath.Join(baseDirectory, filename))

// This will only open files under baseDirectory.
f, err := os.OpenInRoot(baseDirectory, filename)
</code></pre>
<h2 id="future-work">Future work</h2>
<p>The <code>os.Root</code> API is new in Go 1.24.
We expect to make additions and refinements to it in future releases.</p>
<p>The current implementation prioritizes correctness and safety over performance.
Future versions will take advantage of platform-specific APIs, such as
Linux&rsquo;s <code>openat2</code>, to improve performance where possible.</p>
<p>There are a number of filesystem operations which <code>Root</code> does not support yet, such as
creating symbolic links and renaming files. Where possible, we will add support for these
operations. A list of additional functions in progress is in
<a href="/issue/67002">go.dev/issue/67002</a>.</p>

    </div>

    
    <div class="Article prevnext">
    
    
      
    
      
    
      
    
      
    
      
        <p>
        
          
            <b>Next article: </b><a href="/blog/coretypes">Goodbye core types - Hello Go as we know and love it!</a><br>
          
        
        
          
            <b>Previous article: </b><a href="/blog/cleanups-and-weak">From unique to cleanups and weak: new low-level tools for efficiency</a><br>
          
        
        <b><a href="/blog/all">Blog Index</a></b>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    </div>
    

  </div>
</div>

<script src="/js/play.js"></script>

</div>
          </li>
  
          <li>
            <a href="https://go.dev/blog/cleanups-and-weak" target="_blank">From unique to cleanups and weak: new low-level tools for efficiency</a>
            <div class="item-content">
<div id="blog"><div id="content">
  <div id="content">

    <div class="Article" data-slug="/blog/cleanups-and-weak">
    
    <h1 class="small"><a href="/blog/">The Go Blog</a></h1>
    

    <h1>From unique to cleanups and weak: new low-level tools for efficiency</h1>
      
      <p class="author">
      Michael Knyszek<br>
      6 March 2025
      </p>
      
      <p>In <a href="/blog/unique">last year&rsquo;s blog post</a> about the <code>unique</code> package, we alluded
to some new features then in proposal review, and we&rsquo;re excited to share that as
of Go 1.24 they are now available to all Go developers.
These new features are <a href="https://pkg.go.dev/runtime#AddCleanup" rel="noreferrer" target="_blank">the <code>runtime.AddCleanup</code>
function</a>, which queues up a function to
run when an object is no longer reachable, and <a href="https://pkg.go.dev/weak#Pointer" rel="noreferrer" target="_blank">the <code>weak.Pointer</code>
type</a>, which safely points to an object without
preventing it from being garbage collected.
Together, these two features are powerful enough to build your own <code>unique</code>
package!
Let&rsquo;s dig into what makes these features useful, and when to use them.</p>
<p>Note: these new features are advanced features of the garbage collector.
If you&rsquo;re not already familiar with basic garbage collection concepts, we
strongly recommend reading the introduction of our <a href="/doc/gc-guide#Introduction">garbage collector
guide</a>.</p>
<h2 id="cleanups">Cleanups</h2>
<p>If you&rsquo;ve ever used a finalizer, then the concept of a cleanup will be
familiar.
A finalizer is a function, associated with an allocated object by <a href="https://pkg.go.dev/runtime#SetFinalizer" rel="noreferrer" target="_blank">calling
<code>runtime.SetFinalizer</code></a>, that is later
called by the garbage collector some time after the object becomes unreachable.
At a high level, cleanups work the same way.</p>
<p>Let&rsquo;s consider an application that makes use of a memory-mapped file, and see
how cleanups can help.</p>
<pre><code>//go:build unix

type MemoryMappedFile struct {
    data []byte
}

func NewMemoryMappedFile(filename string) (*MemoryMappedFile, error) {
    f, err := os.Open(filename)
    if err != nil {
        return nil, err
    }
    defer f.Close()

    // Get the file's info; we need its size.
    fi, err := f.Stat()
    if err != nil {
        return nil, err
    }

    // Extract the file descriptor.
    conn, err := f.SyscallConn()
    if err != nil {
        return nil, err
    }
    var data []byte
    connErr := conn.Control(func(fd uintptr) {
        // Create a memory mapping backed by this file.
        data, err = syscall.Mmap(int(fd), 0, int(fi.Size()), syscall.PROT_READ, syscall.MAP_SHARED)
    })
    if connErr != nil {
        return nil, connErr
    }
    if err != nil {
        return nil, err
    }
    mf := &amp;MemoryMappedFile{data: data}
    cleanup := func(data []byte) {
        syscall.Munmap(data) // ignore error
    }
    runtime.AddCleanup(mf, cleanup, data)
    return mf, nil
}
</code></pre>
<p>A memory-mapped file has its contents mapped to memory, in this case, the
underlying data of a byte slice.
Thanks to operating-system magic, reads and writes to the byte slice directly
access the contents of the file.
With this code, we can pass around a <code>*MemoryMappedFile</code>, and when it&rsquo;s
no longer referenced, the memory mapping we created will get cleaned up.</p>
<p>Notice that <code>runtime.AddCleanup</code> takes three arguments: the address of a
variable to attach the cleanup to, the cleanup function itself, and an argument
to the cleanup function.
A key difference between this function and <code>runtime.SetFinalizer</code> is that the
cleanup function takes a different argument than the object we&rsquo;re attaching the
cleanup to.
This change fixes some problems with finalizers.</p>
<p>It&rsquo;s no secret that <a href="/doc/gc-guide#Common_finalizer_issues">finalizers
are difficult to use correctly</a>.
For example, objects to which finalizers are attached must not be involved
in any reference cycles (even a pointer to itself is too much!), otherwise the
object will never be reclaimed and the finalizer will never run, causing a
leak.
Finalizers also significantly delay reclamation of memory.
It takes at a minimum two full garbage collection cycles to reclaim the
memory for a finalized object: one to determine that it&rsquo;s unreachable, and
another to determine that it&rsquo;s still unreachable after the finalizer
executes.</p>
<p>The problem is that finalizers <a href="https://en.wikipedia.org/wiki/Object_resurrection" rel="noreferrer" target="_blank">resurrect the objects they&rsquo;re attached
to</a>.
The finalizer doesn&rsquo;t run until the object is unreachable, at which point it is
considered &ldquo;dead.&rdquo;
But since the finalizer is called with a pointer to the object, the garbage
collector must prevent the reclamation of that object&rsquo;s memory, and instead must
generate a new reference for the finalizer, making it reachable, or &ldquo;live,&rdquo; once
more.
That reference may even remain after the finalizer returns, for example if the
finalizer writes it to a global variable or sends it across a channel.
Object resurrection is problematic because it means the object, and everything
it points to, and everything those objects point to, and so on, is reachable,
even if it would otherwise have been collected as garbage.</p>
<p>We solve both of these problems by not passing the original object to the
cleanup function.
First, the values the object refers to don&rsquo;t need to be kept specially
reachable by the garbage collector, so the object can still be reclaimed even
if it&rsquo;s involved in a cycle.
Second, since the object is not needed for the cleanup, its memory can be
reclaimed immediately.</p>
<h2 id="weak-pointers">Weak pointers</h2>
<p>Returning to our memory-mapped file example, suppose we notice that our program
frequently maps the same files over and over, from different goroutines that are
unaware of each other.
This is fine from a memory perspective, since all these mappings will share
physical memory, but it results in lots of unnecessary system calls to map and
unmap the file.
This is especially bad if each goroutine reads only a small section of each
file.</p>
<p>So, let&rsquo;s deduplicate the mappings by filename.
(Let&rsquo;s assume that our program only reads from the mappings, and the files
themselves are never modified or renamed once created.
Such assumptions are reasonable for system font files, for example.)</p>
<p>We could maintain a map from filename to memory mapping, but then it becomes
unclear when it&rsquo;s safe to remove entries from that map.
We could <em>almost</em> use a cleanup, if it weren&rsquo;t for the fact that the map entry
itself will keep the memory-mapped file object alive.</p>
<p>Weak pointers solve this problem.
A weak pointer is a special kind of pointer that the garbage collector ignores
when deciding whether an object is reachable.
Go 1.24&rsquo;s <a href="https://pkg.go.dev/weak#Pointer" rel="noreferrer" target="_blank">new weak pointer type,
<code>weak.Pointer</code></a>, has a <code>Value</code> method that
returns either a real pointer if the object is still reachable, or <code>nil</code> if it
is not.</p>
<p>If we instead maintain a map that only <em>weakly</em> points to the memory-mapped
file, we can clean up the map entry when nobody&rsquo;s using it anymore!
Let&rsquo;s see what this looks like.</p>
<pre><code>var cache sync.Map // map[string]weak.Pointer[MemoryMappedFile]

func NewCachedMemoryMappedFile(filename string) (*MemoryMappedFile, error) {
    var newFile *MemoryMappedFile
    for {
        // Try to load an existing value out of the cache.
        value, ok := cache.Load(filename)
        if !ok {
            // No value found. Create a new mapped file if needed.
            if newFile == nil {
                var err error
                newFile, err = NewMemoryMappedFile(filename)
                if err != nil {
                    return nil, err
                }
            }

            // Try to install the new mapped file.
            wp := weak.Make(newFile)
            var loaded bool
            value, loaded = cache.LoadOrStore(filename, wp)
            if !loaded {
                runtime.AddCleanup(newFile, func(filename string) {
                    // Only delete if the weak pointer is equal. If it's not, someone
                    // else already deleted the entry and installed a new mapped file.
                    cache.CompareAndDelete(filename, wp)
                }, filename)
                return newFile, nil
            }
            // Someone got to installing the file before us.
            //
            // If it's still there when we check in a moment, we'll discard newFile
            // and it'll get cleaned up by garbage collector.
        }

        // See if our cache entry is valid.
        if mf := value.(weak.Pointer[MemoryMappedFile]).Value(); mf != nil {
            return mf, nil
        }

        // Discovered a nil entry awaiting cleanup. Eagerly delete it.
        cache.CompareAndDelete(filename, value)
    }
}
</code></pre>
<p>This example is a little complicated, but the gist is simple.
We start with a global concurrent map of all the mapped files we made.
<code>NewCachedMemoryMappedFile</code> consults this map for an existing mapped
file, and if that fails, creates and tries to insert a new mapped file.
This could of course fail as well since we&rsquo;re racing with other insertions, so
we need to be careful about that too, and retry.
(This design has a flaw in that we might wastefully map the same file multiple
times in a race, and we&rsquo;ll have to throw it away via the cleanup added by
<code>NewMemoryMappedFile</code>.
This is probably not a big deal most of the time.
Fixing it is left as an exercise for the reader.)</p>
<p>Let&rsquo;s look at some useful properties of weak pointers and cleanups exploited by
this code.</p>
<p>Firstly, notice that weak pointers are comparable.
Not only that, weak pointers have a stable and independent identity, which
remains even after the objects they point to are long gone.
This is why it is safe for the cleanup function to call <code>sync.Map</code>&rsquo;s
<code>CompareAndDelete</code>, which compares the <code>weak.Pointer</code>, and a crucial reason
this code works at all.</p>
<p>Secondly, observe that we can add multiple independent cleanups to a single
<code>MemoryMappedFile</code> object.
This allows us to use cleanups in a composable way and use them to build
generic data structures.
In this particular example, it might be more efficient to combine
<code>NewCachedMemoryMappedFile</code> with <code>NewMemoryMappedFile</code> and
have them share a cleanup.
However, the advantage of the code we wrote above is that it can be rewritten
in a generic way!</p>
<pre><code>type Cache[K comparable, V any] struct {
    create func(K) (*V, error)
    m     sync.Map
}

func NewCache[K comparable, V any](create func(K) (*V, error)) *Cache[K, V] {
    return &amp;Cache[K, V]{create: create}
}

func (c *Cache[K, V]) Get(key K) (*V, error) {
    var newValue *V
    for {
        // Try to load an existing value out of the cache.
        value, ok := cache.Load(key)
        if !ok {
            // No value found. Create a new mapped file if needed.
            if newValue == nil {
                var err error
                newValue, err = c.create(key)
                if err != nil {
                    return nil, err
                }
            }

            // Try to install the new mapped file.
            wp := weak.Make(newValue)
            var loaded bool
            value, loaded = cache.LoadOrStore(key, wp)
            if !loaded {
                runtime.AddCleanup(newValue, func(key K) {
                    // Only delete if the weak pointer is equal. If it's not, someone
                    // else already deleted the entry and installed a new mapped file.
                    cache.CompareAndDelete(key, wp)
                }, key)
                return newValue, nil
            }
        }

        // See if our cache entry is valid.
        if mf := value.(weak.Pointer[V]).Value(); mf != nil {
            return mf, nil
        }

        // Discovered a nil entry awaiting cleanup. Eagerly delete it.
        cache.CompareAndDelete(key, value)
    }
}
</code></pre>
<h2 id="caveats-and-future-work">Caveats and future work</h2>
<p>Despite our best efforts, cleanups and weak pointers can still be error-prone.
To guide those considering using finalizers, cleanups, and weak pointers, we
recently updated the <a href="/doc/gc-guide#Finalizers_cleanups_and_weak_pointers">guide to the garbage
collector</a> with some advice
about using these features.
Take a look next time you reach for them, but also carefully consider whether
you need to use them at all.
These are advanced tools with subtle semantics and, as the guide says, most
Go code benefits from these features indirectly, not from using them directly.
Stick to the use-cases where these features shine, and you&rsquo;ll be alright.</p>
<p>For now, we&rsquo;ll call out some of the issues that you are more likely to run into.</p>
<p>First, the object the cleanup is attached to must be reachable from neither
the cleanup function (as a captured variable) nor the argument to the cleanup
function.
Both of these situations result in the cleanup never executing.
(In the special case of the cleanup argument being exactly the pointer passed
to <code>runtime.AddCleanup</code>, <code>runtime.AddCleanup</code> will panic, as a signal to the
caller that they should not use cleanups the same way as finalizers.)</p>
<p>Second, when weak pointers are used as map keys, the weakly referenced object
must not be reachable from the corresponding map value, otherwise the object
will continue to remain live.
This may seem obvious when deep inside of a blog post about weak pointers, but
it&rsquo;s an easy subtlety to miss.
This problem inspired the entire concept of an
<a href="https://en.wikipedia.org/wiki/Ephemeron" rel="noreferrer" target="_blank">ephemeron</a> to resolve it, which is a
potential future direction.</p>
<p>Thirdly, a common pattern with cleanups is that a wrapper object is needed, like
we see here with our <code>MemoryMappedFile</code> example.
In this particular case, you could imagine the garbage collector directly
tracking the mapped memory region and passing around the inner <code>[]byte</code>.
Such functionality is possible future work, and an API for it has been recently
<a href="/issue/70224">proposed</a>.</p>
<p>Lastly, both weak pointers and cleanups are inherently non-deterministic, their
behavior depending intimately on the design and dynamics of the garbage
collector.
The documentation for cleanups even permits the garbage collector never to run
cleanups at all.
Effectively testing code that uses them can be tricky, but <a href="/doc/gc-guide#Testing_object_death">it is
possible</a>.</p>
<h2 id="why-now">Why now?</h2>
<p>Weak pointers have been brought up as a feature for Go since nearly the
beginning, but for years were not prioritized by the Go team.
One reason for that is that they are subtle, and the design space of weak
pointers is a minefield of decisions that can make them even harder to use.
Another is that weak pointers are a niche tool, while simultaneously adding
complexity to the language.
We already had experience with how painful <code>SetFinalizer</code> could be to use.
But there are some useful programs that are not expressible without them, and
the <code>unique</code> package and the reasons for its existence really emphasized that.</p>
<p>With generics, the hindsight of finalizers, and insights from all the great work
since done by teams in other languages like C# and Java, the designs for weak
pointers and cleanups came together quickly.
The desire to use weak pointers with finalizers raised additional questions,
and so the design for <code>runtime.AddCleanup</code> quickly came together as well.</p>
<h2 id="acknowledgements">Acknowledgements</h2>
<p>I want to thank everyone in the community who contributed feedback on the
proposal issues and filed bugs when the features became available.
I also want to thank David Chase for thoroughly thinking through weak
pointer semantics with me, and I want to thank him, Russ Cox, and Austin
Clements for their help with the design of <code>runtime.AddCleanup</code>.
I want to thank Carlos Amedee for his work on getting <code>runtime.AddCleanup</code>
implemented, polished, landed for Go 1.24.
And finally I want to thank Carlos Amedee and Ian Lance Taylor for their work
replacing <code>runtime.SetFinalizer</code> with <code>runtime.AddCleanup</code> throughout the
standard library for Go 1.25.</p>

    </div>

    
    <div class="Article prevnext">
    
    
      
    
      
    
      
    
      
    
      
    
      
        <p>
        
          
            <b>Next article: </b><a href="/blog/osroot">Traversal-resistant file APIs</a><br>
          
        
        
          
            <b>Previous article: </b><a href="/blog/swisstable">Faster Go maps with Swiss Tables</a><br>
          
        
        <b><a href="/blog/all">Blog Index</a></b>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    </div>
    

  </div>
</div>

<script src="/js/play.js"></script>

</div>
          </li>
  
          <li>
            <a href="https://go.dev/blog/swisstable" target="_blank">Faster Go maps with Swiss Tables</a>
            <div class="item-content">
<div id="blog"><div id="content">
  <div id="content">

    <div class="Article" data-slug="/blog/swisstable">
    
    <h1 class="small"><a href="/blog/">The Go Blog</a></h1>
    

    <h1>Faster Go maps with Swiss Tables</h1>
      
      <p class="author">
      Michael Pratt<br>
      26 February 2025
      </p>
      
      <p>The hash table is a central data structure in computer science, and it provides the implementation for the map type in many languages, including Go.</p>
<p>The concept of a hash table was <a href="https://spectrum.ieee.org/hans-peter-luhn-and-the-birth-of-the-hashing-algorithm" rel="noreferrer" target="_blank">first described</a> by Hans Peter Luhn in 1953 in an internal IBM memo that suggested speeding up search by placing items into &ldquo;buckets&rdquo; and using a linked list for overflow when buckets already contain an item.
Today we would call this a <a href="https://en.wikipedia.org/wiki/Hash_table#Separate_chaining" rel="noreferrer" target="_blank">hash table using chaining</a>.</p>
<p>In 1954, Gene M. Amdahl, Elaine M. McGraw, and Arthur L. Samuel first used an &ldquo;open addressing&rdquo; scheme when programming the IBM 701.
When a bucket already contains an item, the new item is placed in the next empty bucket.
This idea was formalized and published in 1957 by W. Wesley Peterson in <a href="https://ieeexplore.ieee.org/document/5392733" rel="noreferrer" target="_blank">&ldquo;Addressing for Random-Access Storage&rdquo;</a>.
Today we would call this a <a href="https://en.wikipedia.org/wiki/Hash_table#Open_addressing" rel="noreferrer" target="_blank">hash table using open addressing with linear probing</a>.</p>
<p>With data structures that have been around this long, it&rsquo;s easy to think that they must be &ldquo;done&rdquo;; that we know everything there is to know about them and they can&rsquo;t be improved anymore.
That&rsquo;s not true!
Computer science research continues to make advancements in fundamental algorithms, both in terms of algorithmic complexity and taking advantage of modern CPU hardware.
For example, Go 1.19 <a href="/doc/go1.19#sortpkgsort">switched the <code>sort</code> package</a> from a traditional quicksort, to <a href="https://arxiv.org/pdf/2106.05123.pdf" rel="noreferrer" target="_blank">pattern-defeating quicksort</a>, a novel sorting algorithm from Orson R. L. Peters, first described in 2015.</p>
<p>Like sorting algorithms, hash table data structures continue to see improvements.
In 2017, Sam Benzaquen, Alkis Evlogimenos, Matt Kulukundis, and Roman Perepelitsa at Google presented <a href="https://www.youtube.com/watch?v=ncHmEUmJZf4" rel="noreferrer" target="_blank">a new C++ hash table design</a>, dubbed &ldquo;Swiss Tables&rdquo;.
In 2018, their implementation was <a href="https://abseil.io/blog/20180927-swisstables" rel="noreferrer" target="_blank">open sourced in the Abseil C++ library</a>.</p>
<p>Go 1.24 includes a completely new implementation of the built-in map type, based on the Swiss Table design.
In this blog post we&rsquo;ll look at how Swiss Tables improve upon traditional hash tables, and at some of the unique challenges in bringing the Swiss Table design to Go&rsquo;s maps.</p>
<h2 id="open-addressed-hash-table">Open-addressed hash table</h2>
<p>Swiss Tables are a form of open-addressed hash table, so let&rsquo;s do a quick overview of how a basic open-addressed hash table works.</p>
<p>In an open-addressed hash table, all items are stored in a single backing array.
We&rsquo;ll call each location in the array a <em>slot</em>.
The slot to which a key belongs is primarily determined by the <em>hash function</em>, <code>hash(key)</code>.
The hash function maps each key to an integer, where the same key always maps to the same integer, and different keys ideally follow a uniform random distribution of integers.
The defining feature of open-addressed hash tables is that they resolve collisions by storing the key elsewhere in the backing array.
So, if the slot is already full (a <em>collision</em>), then a <em>probe sequence</em> is used to consider other slots until an empty slot is found.
Let&rsquo;s take a look at a sample hash table to see how this works.</p>
<h3 id="example">Example</h3>
<p>Below you can see a 16-slot backing array for a hash table, and the key (if any) stored in each slot.
The values are not shown, as they are not relevant to this example.</p>
<style>
 
@media screen and (max-width: 55em) {
    .swisstable-table-container {
         
        overflow: scroll;
    }
}

.swisstable-table {
     
    border-collapse: collapse;
     
    table-layout: fixed;
     
    margin: 0 auto;
}

.swisstable-table-cell {
     
    border: 1px solid;
     
    padding: 0.5em 1em 0.5em 1em;
     
    text-align: center;
}
</style>
<div class="swisstable-table-container">
    <table class="swisstable-table">
        <thead>
            <tr>
                <th class="swisstable-table-cell">Slot</th>
                <th class="swisstable-table-cell">0</th>
                <th class="swisstable-table-cell">1</th>
                <th class="swisstable-table-cell">2</th>
                <th class="swisstable-table-cell">3</th>
                <th class="swisstable-table-cell">4</th>
                <th class="swisstable-table-cell">5</th>
                <th class="swisstable-table-cell">6</th>
                <th class="swisstable-table-cell">7</th>
                <th class="swisstable-table-cell">8</th>
                <th class="swisstable-table-cell">9</th>
                <th class="swisstable-table-cell">10</th>
                <th class="swisstable-table-cell">11</th>
                <th class="swisstable-table-cell">12</th>
                <th class="swisstable-table-cell">13</th>
                <th class="swisstable-table-cell">14</th>
                <th class="swisstable-table-cell">15</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="swisstable-table-cell">Key</td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell">56</td>
                <td class="swisstable-table-cell">32</td>
                <td class="swisstable-table-cell">21</td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell">78</td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
            </tr>
        </tbody>
    </table>
</div>
<p>To insert a new key, we use the hash function to select a slot.
Since there are only 16 slots, we need to restrict to this range, so we&rsquo;ll use <code>hash(key) % 16</code> as the target slot.
Suppose we want to insert key <code>98</code> and <code>hash(98) % 16 = 7</code>.
Slot 7 is empty, so we simply insert 98 there.
On the other hand, suppose we want to insert key <code>25</code> and <code>hash(25) % 16 = 3</code>.
Slot 3 is a collision because it already contains key 56.
Thus we cannot insert here.</p>
<p>We use a probe sequence to find another slot.
There are a variety of well-known probe sequences.
The original and most straightforward probe sequence is <em>linear probing</em>, which simply tries successive slots in order.</p>
<p>So, in the <code>hash(25) % 16 = 3</code> example, since slot 3 is in use, we would consider slot 4 next, which is also in use.
So too is slot 5.
Finally, we&rsquo;d get to empty slot 6, where we&rsquo;d store key 25.</p>
<p>Lookup follows the same approach.
A lookup of key 25 would start at slot 3, check whether it contains key 25 (it does not), and then continue linear probing until it finds key 25 in slot 6.</p>
<p>This example uses a backing array with 16 slots.
What happens if we insert more than 16 elements?
If the hash table runs out of space, it will grow, usually by doubling the size of the backing array.
All existing entries are reinserted into the new backing array.</p>
<p>Open-addressed hash tables don&rsquo;t actually wait until the backing array is completely full to grow because as the array gets more full, the average length of each probe sequence increases.
In the example above using key 25, we must probe 4 different slots to find an empty slot.
If the array had only one empty slot, the worst case probe length would be O(n).
That is, you may need to scan the entire array.
The proportion of used slots is called the <em>load factor</em>, and most hash tables define a <em>maximum load factor</em> (typically 70-90%) at which point they will grow to avoid the extremely long probe sequences of very full hash tables.</p>
<h2 id="swiss-table">Swiss Table</h2>
<p>The Swiss Table <a href="https://abseil.io/about/design/swisstables" rel="noreferrer" target="_blank">design</a> is also a form of open-addressed hash table.
Let&rsquo;s see how it improves over a traditional open-addressed hash table.
We still have a single backing array for storage, but we will break the array into logical <em>groups</em> of 8 slots each.
(Larger group sizes are possible as well. More on that below.)</p>
<p>In addition, each group has a 64-bit <em>control word</em> for metadata.
Each of the 8 bytes in the control word corresponds to one of the slots in the group.
The value of each byte denotes whether that slot is empty, deleted, or in use.
If it is in use, the byte contains the lower 7 bits of the hash for that slot&rsquo;s key (called <code>h2</code>).</p>
<div class="swisstable-table-container">
    <table class="swisstable-table">
        <thead>
            <tr>
                <th class="swisstable-table-cell"></th>
                <th class="swisstable-table-cell" colspan="8">Group 0</th>
                <th class="swisstable-table-cell" colspan="8">Group 1</th>
            </tr>
            <tr>
                <th class="swisstable-table-cell">Slot</th>
                <th class="swisstable-table-cell">0</th>
                <th class="swisstable-table-cell">1</th>
                <th class="swisstable-table-cell">2</th>
                <th class="swisstable-table-cell">3</th>
                <th class="swisstable-table-cell">4</th>
                <th class="swisstable-table-cell">5</th>
                <th class="swisstable-table-cell">6</th>
                <th class="swisstable-table-cell">7</th>
                <th class="swisstable-table-cell">0</th>
                <th class="swisstable-table-cell">1</th>
                <th class="swisstable-table-cell">2</th>
                <th class="swisstable-table-cell">3</th>
                <th class="swisstable-table-cell">4</th>
                <th class="swisstable-table-cell">5</th>
                <th class="swisstable-table-cell">6</th>
                <th class="swisstable-table-cell">7</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="swisstable-table-cell">Key</td>
                <td class="swisstable-table-cell">56</td>
                <td class="swisstable-table-cell">32</td>
                <td class="swisstable-table-cell">21</td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell">78</td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
            </tr>
        </tbody>
    </table>
    <br/> 
    <table class="swisstable-table">
        <thead>
            <tr>
                <th class="swisstable-table-cell"></th>
                <th class="swisstable-table-cell" colspan="8">64-bit control word 0</th>
                <th class="swisstable-table-cell" colspan="8">64-bit control word 1</th>
            </tr>
            <tr>
                <th class="swisstable-table-cell">Slot</th>
                <th class="swisstable-table-cell">0</th>
                <th class="swisstable-table-cell">1</th>
                <th class="swisstable-table-cell">2</th>
                <th class="swisstable-table-cell">3</th>
                <th class="swisstable-table-cell">4</th>
                <th class="swisstable-table-cell">5</th>
                <th class="swisstable-table-cell">6</th>
                <th class="swisstable-table-cell">7</th>
                <th class="swisstable-table-cell">0</th>
                <th class="swisstable-table-cell">1</th>
                <th class="swisstable-table-cell">2</th>
                <th class="swisstable-table-cell">3</th>
                <th class="swisstable-table-cell">4</th>
                <th class="swisstable-table-cell">5</th>
                <th class="swisstable-table-cell">6</th>
                <th class="swisstable-table-cell">7</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="swisstable-table-cell">h2</td>
                <td class="swisstable-table-cell">23</td>
                <td class="swisstable-table-cell">89</td>
                <td class="swisstable-table-cell">50</td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell">47</td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
                <td class="swisstable-table-cell"></td>
            </tr>
        </tbody>
    </table>
</div>
<p>Insertion works as follows:</p>
<ol>
<li>Compute <code>hash(key)</code> and break the hash into two parts: the upper 57-bits (called <code>h1</code>) and the lower 7 bits (called <code>h2</code>).</li>
<li>The upper bits (<code>h1</code>) are used to select the first group to consider: <code>h1 % 2</code> in this case, as there are only 2 groups.</li>
<li>Within a group, all slots are equally eligible to hold the key. We must first determine whether any slot already contains this key, in which case this is an update rather than a new insertion.</li>
<li>If no slot contains the key, then we look for an empty slot to place this key.</li>
<li>If no slot is empty, then we continue the probe sequence by searching the next group.</li>
</ol>
<p>Lookup follows the same basic process.
If we find an empty slot in step 4, then we know an insertion would have used this slot and can stop the search.</p>
<p>Step 3 is where the Swiss Table magic happens.
We need to check whether any slot in a group contains the desired key.
Naively, we could just do a linear scan and compare all 8 keys.
However, the control word lets us do this more efficiently.
Each byte contains the lower 7 bits of the hash (<code>h2</code>) for that slot.
If we determine which bytes of the control word contain the <code>h2</code> we are looking for, we&rsquo;ll have a set of candidate matches.</p>
<p>In other words, we want to do a byte-by-byte equality comparison within the control word.
For example, if we are looking for key 32, where <code>h2 = 89</code>, the operation we want looks like so.</p>
<div class="swisstable-table-container">
    <table class="swisstable-table">
        <tbody>
            <tr>
                <td class="swisstable-table-cell"><strong>Test word</strong></td>
                <td class="swisstable-table-cell">89</td>
                <td class="swisstable-table-cell">89</td>
                <td class="swisstable-table-cell">89</td>
                <td class="swisstable-table-cell">89</td>
                <td class="swisstable-table-cell">89</td>
                <td class="swisstable-table-cell">89</td>
                <td class="swisstable-table-cell">89</td>
                <td class="swisstable-table-cell">89</td>
            </tr>
            <tr>
                <td class="swisstable-table-cell"><strong>Comparison</strong></td>
                <td class="swisstable-table-cell">==</td>
                <td class="swisstable-table-cell">==</td>
                <td class="swisstable-table-cell">==</td>
                <td class="swisstable-table-cell">==</td>
                <td class="swisstable-table-cell">==</td>
                <td class="swisstable-table-cell">==</td>
                <td class="swisstable-table-cell">==</td>
                <td class="swisstable-table-cell">==</td>
            </tr>
            <tr>
                <td class="swisstable-table-cell"><strong>Control word</strong></td>
                <td class="swisstable-table-cell">23</td>
                <td class="swisstable-table-cell">89</td>
                <td class="swisstable-table-cell">50</td>
                <td class="swisstable-table-cell">-</td>
                <td class="swisstable-table-cell">-</td>
                <td class="swisstable-table-cell">-</td>
                <td class="swisstable-table-cell">-</td>
                <td class="swisstable-table-cell">-</td>
            </tr>
            <tr>
                <td class="swisstable-table-cell"><strong>Result</strong></td>
                <td class="swisstable-table-cell">0</td>
                <td class="swisstable-table-cell">1</td>
                <td class="swisstable-table-cell">0</td>
                <td class="swisstable-table-cell">0</td>
                <td class="swisstable-table-cell">0</td>
                <td class="swisstable-table-cell">0</td>
                <td class="swisstable-table-cell">0</td>
                <td class="swisstable-table-cell">0</td>
            </tr>
        </tbody>
    </table>
</div>
<p>This is an operation supported by <a href="https://en.wikipedia.org/wiki/Single_instruction,_multiple_data" rel="noreferrer" target="_blank">SIMD</a> hardware, where a single instruction performs parallel operations on independent values within a larger value (<em>vector</em>). In this case, we <a href="https://cs.opensource.google/go/go/+/master:src/internal/runtime/maps/group.go;drc=a08984bc8f2acacebeeadf7445ecfb67b7e7d7b1;l=155?ss=go" rel="noreferrer" target="_blank">can implement this operation</a> using a set of standard arithmetic and bitwise operations when special SIMD hardware is not available.</p>
<p>The result is a set of candidate slots.
Slots where <code>h2</code> does not match do not have a matching key, so they can be skipped.
Slots where <code>h2</code> does match are potential matches, but we must still check the entire key, as there is potential for collisions (1/128 probability of collision with a 7-bit hash, so still quite low).</p>
<p>This operation is very powerful, as we have effectively performed 8 steps of a probe sequence at once, in parallel.
This speeds up lookup and insertion by reducing the average number of comparisons we need to perform.
This improvement to probing behavior allowed both the Abseil and Go implementations to increase the maximum load factor of Swiss Table maps compared to prior maps, which lowers the average memory footprint.</p>
<h2 id="go-challenges">Go challenges</h2>
<p>Go&rsquo;s built-in map type has some unusual properties that pose additional challenges to adopting a new map design.
Two were particularly tricky to deal with.</p>
<h3 id="incremental-growth">Incremental growth</h3>
<p>When a hash table reaches its maximum load factor, it needs to grow the backing array.
Typically this means the next insertion doubles the size of the array, and copies all entries to the new array.
Imagine inserting into a map with 1GB of entries.
Most insertions are very fast, but the one insertion that needs to grow the map from 1GB to 2GB will need to copy 1GB of entries, which will take a long time.</p>
<p>Go is frequently used for latency-sensitive servers, so we don&rsquo;t want operations on built-in types that can have arbitrarily large impact on tail latency.
Instead, Go maps grow incrementally, so that each insertion has an upper bound on the amount of growth work it must do.
This bounds the latency impact of a single map insertion.</p>
<p>Unfortunately, the Abseil (C++) Swiss Table design assumes all at once growth, and the probe sequence depends on the total group count, making it difficult to break up.</p>
<p>Go&rsquo;s built-in map addresses this with another layer of indirection by splitting each map into multiple Swiss Tables.
Rather than a single Swiss Table implementing the entire map, each map consists of one or more independent tables that cover a subset of the key space.
An individual table stores a maximum of 1024 entries.
A variable number of upper bits in the hash are used to select which table a key belongs to.
This is a form of <a href="https://en.wikipedia.org/wiki/Extendible_hashing" rel="noreferrer" target="_blank"><em>extendible hashing</em></a>, where the number of bits used increases as needed to differentiate the total number of tables.</p>
<p>During insertion, if an individual table needs to grow, it will do so all at once, but other tables are unaffected.
Thus the upper bound for a single insertion is the latency of growing a 1024-entry table into two 1024-entry tables, copying 1024 entries.</p>
<h3 id="modification-during-iteration">Modification during iteration</h3>
<p>Many hash table designs, including Abseil&rsquo;s Swiss Tables, forbid modifying the map during iteration.
The Go language spec <a href="/ref/spec#For_statements:~:text=The%20iteration%20order,iterations%20is%200.">explicitly allows</a> modifications during iteration, with the following semantics:</p>
<ul>
<li>If an entry is deleted before it is reached, it will not be produced.</li>
<li>If an entry is updated before it is reached, the updated value will be produced.</li>
<li>If a new entry is added, it may or may not be produced.</li>
</ul>
<p>A typical approach to hash table iteration is to simply walk through the backing array and produce values in the order they are laid out in memory.
This approach runs afoul of the above semantics, most notably because insertions may grow the map, which would shuffle the memory layout.</p>
<p>We can avoid the impact of shuffle during growth by having the iterator keep a reference to the table it is currently iterating over.
If that table grows during iteration, we keep using the old version of the table and thus continue to deliver keys in the order of the old memory layout.</p>
<p>Does this work with the above semantics?
New entries added after growth will be missed entirely, as they are only added to the grown table, not the old table.
That&rsquo;s fine, as the semantics allow new entries not to be produced.
Updates and deletions are a problem, though: using the old table could produce stale or deleted entries.</p>
<p>This edge case is addressed by using the old table only to determine the iteration order.
Before actually returning the entry, we consult the grown table to determine whether the entry still exists, and to retrieve the latest value.</p>
<p>This covers all the core semantics, though there are even more small edge cases not covered here.
Ultimately, the permissiveness of Go maps with iteration results in iteration being the most complex part of Go&rsquo;s map implementation.</p>
<h2 id="future-work">Future work</h2>
<p>In <a href="/issue/54766#issuecomment-2542444404">microbenchmarks</a>, map operations are up to 60% faster than in Go 1.23.
Exact performance improvement varies quite a bit due to the wide variety of operations and uses of maps, and some edge cases do regress compared to Go 1.23.
Overall, in full application benchmarks, we found a geometric mean CPU time improvement of around 1.5%.</p>
<p>There are more map improvements we want to investigate for future Go releases.
For example, we may be able to <a href="/issue/70835">increase the locality of</a> operations on maps that are not in the CPU cache.</p>
<p>We could also further improve the control word comparisons.
As described above, we have a portable implementation using standard arithmetic and bitwise operations.
However, some architectures have SIMD instructions that perform this sort of comparison directly.
Go 1.24 already uses 8-byte SIMD instructions for amd64, but we could extend support to other architectures.
More importantly, while standard instructions operate on up to 8-byte words, SIMD instructions nearly always support at least 16-byte words.
This means we could increase the group size to 16 slots, and perform 16 hash comparisons in parallel instead of 8.
This would further decrease the average number of probes required for lookups.</p>
<h2 id="acknowledgements">Acknowledgements</h2>
<p>A Swiss Table-based Go map implementation has been a long time coming, and involved many contributors.
I want to thank YunHao Zhang (<a href="https://github.com/zhangyunhao116" rel="noreferrer" target="_blank">@zhangyunhao116</a>), PJ Malloy (<a href="https://github.com/thepudds" rel="noreferrer" target="_blank">@thepudds</a>), and <a href="https://github.com/andy-wm-arthur" rel="noreferrer" target="_blank">@andy-wm-arthur</a> for building initial versions of a Go Swiss Table implementation.
Peter Mattis (<a href="https://github.com/petermattis" rel="noreferrer" target="_blank">@petermattis</a>) combined these ideas with solutions to the Go challenges above to build <a href="https://pkg.go.dev/github.com/cockroachdb/swiss" rel="noreferrer" target="_blank"><code>github.com/cockroachdb/swiss</code></a>, a Go-spec compliant Swiss Table implementation.
The Go 1.24 built-in map implementation is heavily based on Peter&rsquo;s work.
Thank you to everyone in the community that contributed!</p>

    </div>

    
    <div class="Article prevnext">
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <p>
        
          
            <b>Next article: </b><a href="/blog/cleanups-and-weak">From unique to cleanups and weak: new low-level tools for efficiency</a><br>
          
        
        
          
            <b>Previous article: </b><a href="/blog/synctest">Testing concurrent code with testing/synctest</a><br>
          
        
        <b><a href="/blog/all">Blog Index</a></b>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    </div>
    

  </div>
</div>

<script src="/js/play.js"></script>

</div>
          </li>
  
          <li>
            <a href="https://go.dev/blog/synctest" target="_blank">Testing concurrent code with testing/synctest</a>
            <div class="item-content">
<div id="blog"><div id="content">
  <div id="content">

    <div class="Article" data-slug="/blog/synctest">
    
    <h1 class="small"><a href="/blog/">The Go Blog</a></h1>
    

    <h1>Testing concurrent code with testing/synctest</h1>
      
      <p class="author">
      Damien Neil<br>
      19 February 2025
      </p>
      
      <p>One of Go&rsquo;s signature features is built-in support for concurrency.
Goroutines and channels are simple and effective primitives for
writing concurrent programs.</p>
<p>However, testing concurrent programs can be difficult and error prone.</p>
<p>In Go 1.24, we are introducing a new, experimental
<a href="/pkg/testing/synctest"><code>testing/synctest</code></a> package
to support testing concurrent code. This post will explain the motivation behind
this experiment, demonstrate how to use the synctest package, and discuss its potential future.</p>
<p>In Go 1.24, the <code>testing/synctest</code> package is experimental and
not subject to the Go compatibility promise.
It is not visible by default.
To use it, compile your code with <code>GOEXPERIMENT=synctest</code> set in your environment.</p>
<h2 id="testing-concurrent-programs-is-difficult">Testing concurrent programs is difficult</h2>
<p>To begin with, let us consider a simple example.</p>
<p>The <a href="/pkg/context#AfterFunc"><code>context.AfterFunc</code></a> function
arranges for a function to be called in its own goroutine after a context is canceled.
Here is a possible test for <code>AfterFunc</code>:</p>
<pre><code>func TestAfterFunc(t *testing.T) {
    ctx, cancel := context.WithCancel(context.Background())

    calledCh := make(chan struct{}) // closed when AfterFunc is called
    context.AfterFunc(ctx, func() {
        close(calledCh)
    })

    // TODO: Assert that the AfterFunc has not been called.

    cancel()

    // TODO: Assert that the AfterFunc has been called.
}
</code></pre>
<p>We want to check two conditions in this test:
The function is not called before the context is canceled,
and the function <em>is</em> called after the context is canceled.</p>
<p>Checking a negative in a concurrent system is difficult.
We can easily test that the function has not been called <em>yet</em>,
but how do we check that it <em>will not</em> be called?</p>
<p>A common approach is to wait for some amount of time before
concluding that an event will not happen.
Let&rsquo;s try introducing a helper function to our test which does this.</p>
<pre><code>// funcCalled reports whether the function was called.
funcCalled := func() bool {
    select {
    case &lt;-calledCh:
        return true
    case &lt;-time.After(10 * time.Millisecond):
        return false
    }
}

if funcCalled() {
    t.Fatalf(&quot;AfterFunc function called before context is canceled&quot;)
}

cancel()

if !funcCalled() {
    t.Fatalf(&quot;AfterFunc function not called after context is canceled&quot;)
}
</code></pre>
<p>This test is slow:
10 milliseconds isn&rsquo;t a lot of time, but it adds up over many tests.</p>
<p>This test is also flaky:
10 milliseconds is a long time on a fast computer,
but it isn&rsquo;t unusual to see pauses lasting several seconds
on shared and overloaded
<a href="https://en.wikipedia.org/wiki/Continuous_integration" rel="noreferrer" target="_blank">CI</a>
systems.</p>
<p>We can make the test less flaky at the expense of making it slower,
and we can make it less slow at the expense of making it flakier,
but we can&rsquo;t make it both fast and reliable.</p>
<h2 id="introducing-the-testingsynctest-package">Introducing the testing/synctest package</h2>
<p>The <code>testing/synctest</code> package solves this problem.
It allows us to rewrite this test to be simple, fast, and reliable,
without any changes to the code being tested.</p>
<p>The package contains only two functions: <code>Run</code> and <code>Wait</code>.</p>
<p><code>Run</code> calls a function in a new goroutine.
This goroutine and any goroutines started by it
exist in an isolated environment which we call a <em>bubble</em>.
<code>Wait</code> waits for every goroutine in the current goroutine&rsquo;s bubble
to block on another goroutine in the bubble.</p>
<p>Let&rsquo;s rewrite our test above using the <code>testing/synctest</code> package.</p>
<pre><code>func TestAfterFunc(t *testing.T) {
    synctest.Run(func() {
        ctx, cancel := context.WithCancel(context.Background())

        funcCalled := false
        context.AfterFunc(ctx, func() {
            funcCalled = true
        })

        synctest.Wait()
        if funcCalled {
            t.Fatalf(&quot;AfterFunc function called before context is canceled&quot;)
        }

        cancel()

        synctest.Wait()
        if !funcCalled {
            t.Fatalf(&quot;AfterFunc function not called after context is canceled&quot;)
        }
    })
}
</code></pre>
<p>This is almost identical to our original test,
but we have wrapped the test in a <code>synctest.Run</code> call
and we call <code>synctest.Wait</code> before asserting that the function has been called or not.</p>
<p>The <code>Wait</code> function waits for every goroutine in the caller&rsquo;s bubble to block.
When it returns, we know that the context package has either called the function,
or will not call it until we take some further action.</p>
<p>This test is now both fast and reliable.</p>
<p>The test is simpler, too:
we have replaced the <code>calledCh</code> channel with a boolean.
Previously we needed to use a channel to avoid a data race between
the test goroutine and the <code>AfterFunc</code> goroutine,
but the <code>Wait</code> function now provides that synchronization.</p>
<p>The race detector understands <code>Wait</code> calls,
and this test passes when run with <code>-race</code>.
If we remove the second <code>Wait</code> call,
the race detector will correctly report a data race in the test.</p>
<h2 id="testing-time">Testing time</h2>
<p>Concurrent code often deals with time.</p>
<p>Testing code that works with time can be difficult.
Using real time in tests causes slow and flaky tests,
as we have seen above.
Using fake time requires avoiding <code>time</code> package functions,
and designing the code under test to work with
an optional fake clock.</p>
<p>The <code>testing/synctest</code> package makes it simpler to test code that uses time.</p>
<p>Goroutines in the bubble started by <code>Run</code> use a fake clock.
Within the bubble, functions in the <code>time</code> package operate on the
fake clock. Time advances in the bubble when all goroutines are
blocked.</p>
<p>To demonstrate, let&rsquo;s write a test for the
<a href="/pkg/context#WithTimeout"><code>context.WithTimeout</code></a> function.
<code>WithTimeout</code> creates a child of a context,
which expires after a given timeout.</p>
<pre><code>func TestWithTimeout(t *testing.T) {
    synctest.Run(func() {
        const timeout = 5 * time.Second
        ctx, cancel := context.WithTimeout(context.Background(), timeout)
        defer cancel()

        // Wait just less than the timeout.
        time.Sleep(timeout - time.Nanosecond)
        synctest.Wait()
        if err := ctx.Err(); err != nil {
            t.Fatalf(&quot;before timeout, ctx.Err() = %v; want nil&quot;, err)
        }

        // Wait the rest of the way until the timeout.
        time.Sleep(time.Nanosecond)
        synctest.Wait()
        if err := ctx.Err(); err != context.DeadlineExceeded {
            t.Fatalf(&quot;after timeout, ctx.Err() = %v; want DeadlineExceeded&quot;, err)
        }
    })
}
</code></pre>
<p>We write this test just as if we were working with real time.
The only difference is that we wrap the test function in <code>synctest.Run</code>,
and call <code>synctest.Wait</code> after each <code>time.Sleep</code> call to wait for the context
package&rsquo;s timers to finish running.</p>
<h2 id="blocking-and-the-bubble">Blocking and the bubble</h2>
<p>A key concept in <code>testing/synctest</code> is the bubble becoming <em>durably blocked</em>.
This happens when every goroutine in the bubble is blocked,
and can only be unblocked by another goroutine in the bubble.</p>
<p>When a bubble is durably blocked:</p>
<ul>
<li>If there is an outstanding <code>Wait</code> call, it returns.</li>
<li>Otherwise, time advances to the next time that could unblock a goroutine, if any.</li>
<li>Otherwise, the bubble is deadlocked and <code>Run</code> panics.</li>
</ul>
<p>A bubble is not durably blocked if any goroutine is blocked
but might be woken by some event from outside the bubble.</p>
<p>The complete list of operations which durably block a goroutine is:</p>
<ul>
<li>a send or receive on a nil channel</li>
<li>a send or receive blocked on a channel created within the same bubble</li>
<li>a select statement where every case is durably blocking</li>
<li><code>time.Sleep</code></li>
<li><code>sync.Cond.Wait</code></li>
<li><code>sync.WaitGroup.Wait</code></li>
</ul>
<h3 id="mutexes">Mutexes</h3>
<p>Operations on a <code>sync.Mutex</code> are not durably blocking.</p>
<p>It is common for functions to acquire a global mutex.
For example, a number of functions in the reflect package
use a global cache guarded by a mutex.
If a goroutine in a synctest bubble blocks while acquiring
a mutex held by a goroutine outside the bubble,
it is not durably blocked‚Äîit is blocked, but will be unblocked
by a goroutine from outside its bubble.</p>
<p>Since mutexes are usually not held for long periods of time,
we simply exclude them from <code>testing/synctest</code>&rsquo;s consideration.</p>
<h3 id="channels">Channels</h3>
<p>Channels created within a bubble behave differently from ones created outside.</p>
<p>Channel operations are durably blocking only if the channel is bubbled
(created in the bubble).
Operating on a bubbled channel from outside the bubble panics.</p>
<p>These rules ensure that a goroutine is durably blocked only when
communicating with goroutines within its bubble.</p>
<h3 id="io">I/O</h3>
<p>External I/O operations, such as reading from a network connection,
are not durably blocking.</p>
<p>Network reads may be unblocked by writes from outside the bubble,
possibly even from other processes.
Even if the only writer to a network connection is also in the same bubble,
the runtime cannot distinguish between a connection waiting for more data to arrive
and one where the kernel has received data and is in the process of delivering it.</p>
<p>Testing a network server or client with synctest will generally
require supplying a fake network implementation.
For example, the <a href="/pkg/net#Pipe"><code>net.Pipe</code></a> function
creates a pair of <code>net.Conn</code>s that use an in-memory network connection
and can be used in synctest tests.</p>
<h2 id="bubble-lifetime">Bubble lifetime</h2>
<p>The <code>Run</code> function starts a goroutine in a new bubble.
It returns when every goroutine in the bubble has exited.
It panics if the bubble is durably blocked
and cannot be unblocked by advancing time.</p>
<p>The requirement that every goroutine in the bubble exit before Run returns
means that tests must be careful to clean up any background goroutines
before completing.</p>
<h2 id="testing-networked-code">Testing networked code</h2>
<p>Let&rsquo;s look at another example, this time using the <code>testing/synctest</code>
package to test a networked program.
For this example, we&rsquo;ll test the <code>net/http</code> package&rsquo;s handling of
the 100 Continue response.</p>
<p>An HTTP client sending a request can include an &ldquo;Expect: 100-continue&rdquo;
header to tell the server that the client has additional data to send.
The server may then respond with a 100 Continue informational response
to request the rest of the request,
or with some other status to tell the client that the content is not needed.
For example, a client uploading a large file might use this feature to
confirm that the server is willing to accept the file before sending it.</p>
<p>Our test will confirm that when sending an &ldquo;Expect: 100-continue&rdquo; header
the HTTP client does not send a request&rsquo;s content before the server
requests it, and that it does send the content after receiving a
100 Continue response.</p>
<p>Often tests of a communicating client and server can use a
loopback network connection. When working with <code>testing/synctest</code>,
however, we will usually want to use a fake network connection
to allow us to detect when all goroutines are blocked on the network.
We&rsquo;ll start this test by creating an <code>http.Transport</code> (an HTTP client) that uses
an in-memory network connection created by <a href="/pkg/net#Pipe"><code>net.Pipe</code></a>.</p>
<pre><code>func Test(t *testing.T) {
    synctest.Run(func() {
        srvConn, cliConn := net.Pipe()
        defer srvConn.Close()
        defer cliConn.Close()
        tr := &amp;http.Transport{
            DialContext: func(ctx context.Context, network, address string) (net.Conn, error) {
                return cliConn, nil
            },
            // Setting a non-zero timeout enables &quot;Expect: 100-continue&quot; handling.
            // Since the following test does not sleep,
            // we will never encounter this timeout,
            // even if the test takes a long time to run on a slow machine.
            ExpectContinueTimeout: 5 * time.Second,
        }
</code></pre>
<p>We send a request on this transport with the &ldquo;Expect: 100-continue&rdquo; header set.
The request is sent in a new goroutine, since it won&rsquo;t complete until the end of the test.</p>
<pre><code>        body := &quot;request body&quot;
        go func() {
            req, _ := http.NewRequest(&quot;PUT&quot;, &quot;http://test.tld/&quot;, strings.NewReader(body))
            req.Header.Set(&quot;Expect&quot;, &quot;100-continue&quot;)
            resp, err := tr.RoundTrip(req)
            if err != nil {
                t.Errorf(&quot;RoundTrip: unexpected error %v&quot;, err)
            } else {
                resp.Body.Close()
            }
        }()
</code></pre>
<p>We read the request headers sent by the client.</p>
<pre><code>        req, err := http.ReadRequest(bufio.NewReader(srvConn))
        if err != nil {
            t.Fatalf(&quot;ReadRequest: %v&quot;, err)
        }
</code></pre>
<p>Now we come to the heart of the test.
We want to assert that the client will not send the request body yet.</p>
<p>We start a new goroutine copying the body sent to the server into a <code>strings.Builder</code>,
wait for all goroutines in the bubble to block, and verify that we haven&rsquo;t read anything
from the body yet.</p>
<p>If we forget the <code>synctest.Wait</code> call, the race detector will correctly complain
about a data race, but with the <code>Wait</code> this is safe.</p>
<pre><code>        var gotBody strings.Builder
        go io.Copy(&amp;gotBody, req.Body)
        synctest.Wait()
        if got := gotBody.String(); got != &quot;&quot; {
            t.Fatalf(&quot;before sending 100 Continue, unexpectedly read body: %q&quot;, got)
        }
</code></pre>
<p>We write a &ldquo;100 Continue&rdquo; response to the client and verify that it now sends the
request body.</p>
<pre><code>        srvConn.Write([]byte(&quot;HTTP/1.1 100 Continue\r\n\r\n&quot;))
        synctest.Wait()
        if got := gotBody.String(); got != body {
            t.Fatalf(&quot;after sending 100 Continue, read body %q, want %q&quot;, got, body)
        }
</code></pre>
<p>And finally, we finish up by sending the &ldquo;200 OK&rdquo; response to conclude the request.</p>
<p>We have started several goroutines during this test.
The <code>synctest.Run</code> call will wait for all of them to exit before returning.</p>
<pre><code>        srvConn.Write([]byte(&quot;HTTP/1.1 200 OK\r\n\r\n&quot;))
    })
}
</code></pre>
<p>This test can be easily extended to test other behaviors,
such as verifying that the request body is not sent if the server does not ask for it,
or that it is sent if the server does not respond within a timeout.</p>
<h2 id="status-of-the-experiment">Status of the experiment</h2>
<p>We are introducing <a href="/pkg/testing/synctest"><code>testing/synctest</code></a>
in Go 1.24 as an <em>experimental</em> package.
Depending on feedback and experience
we may release it with or without amendments,
continue the experiment,
or remove it in a future version of Go.</p>
<p>The package is not visible by default.
To use it, compile your code with <code>GOEXPERIMENT=synctest</code> set in your environment.</p>
<p>We want to hear your feedback!
If you try out <code>testing/synctest</code>,
please report your experiences, positive or negative,
on <a href="/issue/67434">go.dev/issue/67434</a>.</p>

    </div>

    
    <div class="Article prevnext">
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <p>
        
          
            <b>Next article: </b><a href="/blog/swisstable">Faster Go maps with Swiss Tables</a><br>
          
        
        
          
            <b>Previous article: </b><a href="/blog/wasmexport">Extensible Wasm Applications with Go</a><br>
          
        
        <b><a href="/blog/all">Blog Index</a></b>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    </div>
    

  </div>
</div>

<script src="/js/play.js"></script>

</div>
          </li>
  
          <li>
            <a href="https://go.dev/blog/wasmexport" target="_blank">Extensible Wasm Applications with Go</a>
            <div class="item-content">
<div id="blog"><div id="content">
  <div id="content">

    <div class="Article" data-slug="/blog/wasmexport">
    
    <h1 class="small"><a href="/blog/">The Go Blog</a></h1>
    

    <h1>Extensible Wasm Applications with Go</h1>
      
      <p class="author">
      Cherry Mui<br>
      13 February 2025
      </p>
      
      <p>Go 1.24 enhances its WebAssembly (Wasm) capabilities with the
addition of the <code>go:wasmexport</code> directive and the ability to build a reactor
for WebAssembly System Interface (WASI).
These features enable Go developers to export Go functions to Wasm,
facilitating better integration with Wasm hosts and expanding the possibilities
for Go-based Wasm applications.</p>
<h2 id="webassembly-and-the-webassembly-system-interface">WebAssembly and the WebAssembly System Interface</h2>
<p><a href="https://webassembly.org/" rel="noreferrer" target="_blank">WebAssembly (Wasm)</a> is a binary instruction format
that was initially created for web browsers, providing the execution of
high-performance, low-level code at speeds approaching native performance.
Since then, Wasm&rsquo;s utility has expanded, and it is now used in various
environments beyond the browser.
Notably, cloud providers offer services that directly execute Wasm
executables, taking advantage of the
<a href="https://wasi.dev/" rel="noreferrer" target="_blank">WebAssembly System Interface (WASI)</a> system call API.
WASI allows these executables to interact with system resources.</p>
<p>Go first added support for compiling to Wasm in the 1.11 release, through the
<code>js/wasm</code> port.
Go 1.21 added a new port targeting the WASI preview 1 syscall API through the
new <code>GOOS=wasip1</code> port.</p>
<h2 id="exporting-go-functions-to-wasm-with-gowasmexport">Exporting Go Functions to Wasm with <code>go:wasmexport</code></h2>
<p>Go 1.24 introduces a new compiler directive, <code>go:wasmexport</code>, which allows
developers to export Go functions to be called from outside of the
Wasm module, typically from a host application that runs the Wasm runtime.
This directive instructs the compiler to make the annotated function available
as a Wasm <a href="https://webassembly.github.io/spec/core/valid/modules.html?highlight=export#exports" rel="noreferrer" target="_blank">export</a>
in the resulting Wasm binary.</p>
<p>To use the <code>go:wasmexport</code> directive, simply add it to a function definition:</p>
<pre><code>//go:wasmexport add
func add(a, b int32) int32 { return a + b }
</code></pre>
<p>With this, the Wasm module will have an exported function named <code>add</code> that
can be called from the host.</p>
<p>This is analogous to the <a href="/cmd/cgo#hdr-C_references_to_Go">cgo <code>export</code> directive</a>,
which makes the function available to be called from C,
though <code>go:wasmexport</code> uses a different, simpler mechanism.</p>
<h2 id="building-a-wasi-reactor">Building a WASI Reactor</h2>
<p>A WASI reactor is a WebAssembly module that operates continuously, and
can be called upon multiple times to react on events or requests.
Unlike a &ldquo;command&rdquo; module, which terminates after its main function finishes,
a reactor instance remains live after initialization, and its exports remain
accessible.</p>
<p>With Go 1.24, one can build a WASI reactor with the <code>-buildmode=c-shared</code> build
flag.</p>
<pre><code>$ GOOS=wasip1 GOARCH=wasm go build -buildmode=c-shared -o reactor.wasm
</code></pre>
<p>The build flag signals to the linker not to generate the <code>_start</code> function
(the entry point for a command module), and instead generate an
<code>_initialize</code> function, which performs runtime and package initialization,
along with any exported functions and their dependencies.
The <code>_initialize</code> function must be called before any other exported functions.
The <code>main</code> function will not be automatically invoked.</p>
<p>To use a WASI reactor, the host application first initializes it by calling
<code>_initialize</code>, then simply invoke the exported functions.
Here is an example using <a href="https://wazero.io/" rel="noreferrer" target="_blank">Wazero</a>, a Go-based Wasm runtime
implementation:</p>
<pre><code>// Create a Wasm runtime, set up WASI.
r := wazero.NewRuntime(ctx)
defer r.Close(ctx)
wasi_snapshot_preview1.MustInstantiate(ctx, r)

// Configure the module to initialize the reactor.
config := wazero.NewModuleConfig().WithStartFunctions(&quot;_initialize&quot;)

// Instantiate the module.
wasmModule, _ := r.InstantiateWithConfig(ctx, wasmFile, config)

// Call the exported function.
fn := wasmModule.ExportedFunction(&quot;add&quot;)
var a, b int32 = 1, 2
res, _ := fn.Call(ctx, api.EncodeI32(a), api.EncodeI32(b))
c := api.DecodeI32(res[0])
fmt.Printf(&quot;add(%d, %d) = %d\n&quot;, a, b, c)

// The instance is still alive. We can call the function again.
res, _ = fn.Call(ctx, api.EncodeI32(b), api.EncodeI32(c))
fmt.Printf(&quot;add(%d, %d) = %d\n&quot;, b, c, api.DecodeI32(res[0]))
</code></pre>
<p>The <code>go:wasmexport</code> directive and the reactor build mode allow applications to
be extended by calling into Go-based Wasm code.
This is particularly valuable for applications that have adopted Wasm as a
plugin or extension mechanism with well-defined interfaces.
By exporting Go functions, applications can leverage the Go Wasm modules to
provide functionality without needing to recompile the entire application.
Furthermore, building as a reactor ensures that the exported functions can be
called multiple times without requiring reinitialization, making it suitable
for long-running applications or services.</p>
<h2 id="supporting-rich-types-between-the-host-and-the-client">Supporting rich types between the host and the client</h2>
<p>Go 1.24 also relaxes the constraints on types that can be used as input and
result parameters with <code>go:wasmimport</code> functions.
For example, one can pass a bool, a string, a pointer to an <code>int32</code>, or a
pointer to a struct which embeds <code>structs.HostLayout</code> and contains supported
field types
(see the <a href="/cmd/compile#hdr-WebAssembly_Directives">documentation</a> for detail).
This allows Go Wasm applications to be written in a more natural and ergonomic
way, and removes some unnecessary type conversions.</p>
<h2 id="limitations">Limitations</h2>
<p>While Go 1.24 has made significant enhancements to its Wasm capabilities,
there are still some notable limitations.</p>
<p>Wasm is a single-threaded architecture with no parallelism.
A <code>go:wasmexport</code> function can spawn new goroutines.
But if a function creates a background goroutine, it will not continue
executing when the <code>go:wasmexport</code> function returns, until calling back into
the Go-based Wasm module.</p>
<p>While some type restrictions have been relaxed in Go 1.24, there are still
limitations on the types that can be used with <code>go:wasmimport</code> and
<code>go:wasmexport</code> functions.
Due to the unfortunate mismatch between the 64-bit architecture of the client
and the 32-bit architecture of the host, it is not possible to pass pointers in
memory.
For example, a <code>go:wasmimport</code> function cannot take a pointer to a struct that
contains a pointer-typed field.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The addition of the ability to build a WASI reactor and export Go functions to
Wasm in Go 1.24 represent a significant step forward for Go&rsquo;s WebAssembly
capabilities.
These features empower developers to create more versatile and powerful Go-based
Wasm applications, opening up new possibilities for Go in the Wasm ecosystem.</p>

    </div>

    
    <div class="Article prevnext">
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <p>
        
          
            <b>Next article: </b><a href="/blog/synctest">Testing concurrent code with testing/synctest</a><br>
          
        
        
          
            <b>Previous article: </b><a href="/blog/go1.24">Go 1.24 is released!</a><br>
          
        
        <b><a href="/blog/all">Blog Index</a></b>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    </div>
    

  </div>
</div>

<script src="/js/play.js"></script>

</div>
          </li>
  
          <li>
            <a href="https://go.dev/blog/go1.24" target="_blank">Go 1.24 is released!</a>
            <div class="item-content">
<div id="blog"><div id="content">
  <div id="content">

    <div class="Article" data-slug="/blog/go1.24">
    
    <h1 class="small"><a href="/blog/">The Go Blog</a></h1>
    

    <h1>Go 1.24 is released!</h1>
      
      <p class="author">
      Junyang Shao, on behalf of the Go team<br>
      11 February 2025
      </p>
      
      <p>Today the Go team is excited to release Go 1.24,
which you can get by visiting the <a href="/dl/">download page</a>.</p>
<p>Go 1.24 comes with many improvements over Go 1.23. Here are some of the notable
changes; for the full list, refer to the <a href="/doc/go1.24">release notes</a>.</p>
<h2 id="language-changes">Language changes</h2>
<p>Go 1.24 now fully supports <a href="/issue/46477">generic type aliases</a>: a type alias
may be parameterized like a defined type.
See the <a href="/ref/spec#Alias_declarations">language spec</a> for details.</p>
<h2 id="performance-improvements">Performance improvements</h2>
<p>Several performance improvements in the runtime have decreased CPU overhead
by 2‚Äì3% on average across a suite of representative benchmarks. These
improvements include a new builtin <code>map</code> implementation based on
<a href="https://abseil.io/about/design/swisstables" rel="noreferrer" target="_blank">Swiss Tables</a>, more efficient
memory allocation of small objects, and a new runtime-internal mutex
implementation.</p>
<h2 id="tool-improvements">Tool improvements</h2>
<ul>
<li>The <code>go</code> command now provides a mechanism for tracking tool dependencies for a
module. Use <code>go get -tool</code> to add a <code>tool</code> directive to the current module. Use
<code>go tool [tool name]</code> to run the tools declared with the <code>tool</code> directive.
Read more on the <a href="/doc/go1.24#go-command">go command</a> in the release notes.</li>
<li>The new <code>test</code> analyzer in <code>go vet</code> subcommand reports common mistakes in
declarations of tests, fuzzers, benchmarks, and examples in test packages.
Read more on <a href="/doc/go1.24#vet">vet</a> in the release notes.</li>
</ul>
<h2 id="standard-library-additions">Standard library additions</h2>
<ul>
<li>
<p>The standard library now includes <a href="/doc/security/fips140">a new set of mechanisms to facilitate
FIPS 140-3 compliance</a>. Applications require no source code
changes to use the new mechanisms for approved algorithms. Read more
on <a href="/doc/go1.24#fips140">FIPS 140-3 compliance</a> in the release notes.
Apart from FIPS 140, several packages that were previously in the
<a href="/pkg/golang.org/x/crypto">x/crypto</a> module are now available in the
<a href="/doc/go1.24#crypto-mlkem">standard library</a>.</p>
</li>
<li>
<p>Benchmarks may now use the faster and less error-prone
<a href="/pkg/testing#B.Loop"><code>testing.B.Loop</code></a> method to perform benchmark iterations
like <code>for b.Loop() { ... }</code> in place of the typical loop structures involving
<code>b.N</code> like <code>for range b.N</code>. Read more on
<a href="/doc/go1.24#new-benchmark-function">the new benchmark function</a> in the
release notes.</p>
</li>
<li>
<p>The new <a href="/pkg/os#Root"><code>os.Root</code></a> type provides the ability to perform
filesystem operations isolated under a specific directory. Read more on
<a href="/doc/go1.24#directory-limited-filesystem-access">filesystem access</a> in the
release notes.</p>
</li>
<li>
<p>The runtime provides a new finalization mechanism,
<a href="/pkg/runtime#AddCleanup"><code>runtime.AddCleanup</code></a>, that is more flexible,
more efficient, and less error-prone than
<a href="/pkg/runtime#SetFinalizer"><code>runtime.SetFinalizer</code></a>. Read more on
<a href="/doc/go1.24#improved-finalizers">cleanups</a> in the release notes.</p>
</li>
</ul>
<h2 id="improved-webassembly-support">Improved WebAssembly support</h2>
<p>Go 1.24 adds a new <code>go:wasmexport</code> directive for Go programs to export
functions to the WebAssembly host, and supports building a Go program as a WASI
<a href="https://github.com/WebAssembly/WASI/blob/63a46f61052a21bfab75a76558485cf097c0dbba/legacy/application-abi.md#current-unstable-abi" rel="noreferrer" target="_blank">reactor/library</a>.
Read more on <a href="/doc/go1.24#wasm">WebAssembly</a> in the release notes.</p>
<hr>
<p>Please read the <a href="/doc/go1.24">Go 1.24 release notes</a> for the complete and
detailed information. Don&rsquo;t forget to watch for follow-up blog posts that
will go in more depth on some of the topics mentioned here!</p>
<p>Thank you to everyone who contributed to this release by writing code and
documentation, reporting bugs, sharing feedback, and testing the release
candidates. Your efforts helped to ensure that Go 1.24 is as stable as possible.
As always, if you notice any problems, please <a href="/issue/new">file an issue</a>.</p>
<p>Enjoy Go 1.24!</p>

    </div>

    
    <div class="Article prevnext">
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <p>
        
          
            <b>Next article: </b><a href="/blog/wasmexport">Extensible Wasm Applications with Go</a><br>
          
        
        
          
            <b>Previous article: </b><a href="/blog/survey2024-h2-results">Go Developer Survey 2024 H2 Results</a><br>
          
        
        <b><a href="/blog/all">Blog Index</a></b>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    </div>
    

  </div>
</div>

<script src="/js/play.js"></script>

</div>
          </li>
  
        </ul>
      </div>
  
      <div class="card">
        <h2>Reddit</h2>
  
        <h3 class="subreddit">r/rust</h3>
        <ul class="item-list">
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1lmb89c/mrustc_build_errors_exception_unable_to_invoke/" target="_blank">Mrustc build errors - EXCEPTION: Unable to invoke compiler to get config options</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>We&#39;re using mrustc to try and bootstrap a reasonably recent rustc and libstd on sparc64-sun-solaris2.10. Mrustc built and linked successfully, but to build libstd you have to do: <code>make -f minicargo.mk LIBS</code>, which returns <code> Process exited with non-zero exit status 127 EXCEPTION: Unable to invoke compiler to get config options </code></p> <p>Invoking mrustc itself returns: <code> Setup: V V V (0.00 s) Setup: DONE Target Load: V V V Unknown target name &#39;sparc64-sun-solaris2.10&#39; Abort (core dumped) </code></p> <p>Does anyone know how best to debug this or any next steps we should take?</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/ThatSuccubusLilith"> /u/ThatSuccubusLilith </a> <br/> <span><a href="https://www.reddit.com/r/rust/comments/1lmb89c/mrustc_build_errors_exception_unable_to_invoke/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1lmb89c/mrustc_build_errors_exception_unable_to_invoke/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1lm9q7m/what_rustrelated_podcasts_do_you_listen_to/" target="_blank">What Rust-related podcasts do you listen to?</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>It would be great to learn something new, or just catch up on recent news from the Rust ecosystem during my commute. </p> <p>What are your favorite Rust-related podcasts? Preferably related to distributed systems and backends, rather than game dev.</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/Hixon11"> /u/Hixon11 </a> <br/> <span><a href="https://www.reddit.com/r/rust/comments/1lm9q7m/what_rustrelated_podcasts_do_you_listen_to/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1lm9q7m/what_rustrelated_podcasts_do_you_listen_to/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1lm949g/rust_for_beginners/" target="_blank">Rust for Beginners</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>I have just released a beginner&#39;s book on Rust, called, unsurprisingly, &#39;Rust for Beginners&#39;. The book originated from my interest in learning Rust, a language I had wanted to explore for some time. The book isn&#39;t intended for experts, but rather for beginners. It&#39;s intent is to break the ice on what is, a rather novel language, allowing a new developer to transition to more advanced texts. I am sure there are some typos and possibly even conceptual mistakes, but I will update it if and when I receive feedback. Unfortunately, I can&#39;t give any more information as the filters reject the post. </p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/hsauro"> /u/hsauro </a> <br/> <span><a href="https://www.reddit.com/r/rust/comments/1lm949g/rust_for_beginners/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1lm949g/rust_for_beginners/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1lm7cda/pg_mooncake_columnstore_iceberg_mirror_of/" target="_blank">pg_mooncake: columnstore (iceberg) mirror of Postgres tables</a>
            <div class="item-content">&#32; submitted by &#32; <a href="https://www.reddit.com/user/InternetFit7518"> /u/InternetFit7518 </a> <br/> <span><a href="https://github.com/Mooncake-Labs/pg_mooncake">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1lm7cda/pg_mooncake_columnstore_iceberg_mirror_of/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1lm6c4a/what_happens_to_the_original_variable_when_you/" target="_blank">What Happens to the Original Variable When You Shadow It?</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>I&#39;m trying to get my head around shadowing. The Rust book offers an example like:</p> <p><code> let spaces=&quot; &quot;; let spaces=spaces.len(); </code></p> <p>The original is a string type; the second, a number. That makes a measure of sense. I would assume that Rust would, through context, use the string or number version as appropriate. </p> <p>But what if they are the same type?</p> <p><code> let x=1; let x=2; </code></p> <p>Both are numbers. <code>println!(&quot;{x}&quot;);</code> would return <code>2</code>. But is the first instance simply inaccessible? For all intents and purposes, this makes <code>x</code> mutable but taking more memory. Or is there some way I can say &quot;the original <code>x</code>?&quot;</p> <p>(For that matter, in my first example, how could I specify I want the string version of <code>spaces</code> when the context is not clear?)</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/MrGuilt"> /u/MrGuilt </a> <br/> <span><a href="https://www.reddit.com/r/rust/comments/1lm6c4a/what_happens_to_the_original_variable_when_you/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1lm6c4a/what_happens_to_the_original_variable_when_you/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1lm3hzk/media_announcing_sniffnet_v14_its_2x_faster_than/" target="_blank">[MEDIA] Announcing Sniffnet v1.4 ‚Äî it‚Äôs 2X faster than Wireshark at processing Packet Capture files!</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>Sniffnet v1.4 has just been released!</p> <p>Sniffnet is an open-source network monitoring tool developed in Rust, and the latest version of the app includes, among other features, the possibility to import data from PCAP files.</p> <p>The video shows a live session of Sniffnet processing a 1.6 GB file (2.6 million network packets) in about 25 seconds, making it more than 2X faster than Wireshark that takes about 55 seconds to parse the same file on the same machine.</p> <p>To know more about it and this release, you can read the dedicated blog post.</p> <p>Links to the blog post and other resources are in the comments.</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/GyulyVGC"> /u/GyulyVGC </a> <br/> <span><a href="https://i.redd.it/qiyugrvgzi9f1.gif">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1lm3hzk/media_announcing_sniffnet_v14_its_2x_faster_than/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1lm30lj/ide_for_those_using_rustrover_does_linecompletion/" target="_blank">[IDE] For those using RustRover, does line-completion add value to you?</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>I&#39;m a long-time JetBrains users, but am a fledgling Rustacean. Do my fellow RustRover users get value out of the full-line completion it offers? As a new user of the language, I find it disorienting more often than not. It tends to over-assume my intentions and insert long, verbose chunks of code unrelated to what I&#39;m trying to write (particularly if I&#39;m using a 3rd party crate).</p> <p>For those that did not get value from it, did you find a way to reign it in?</p> <p>Thanks for your time!</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/Faalaafeel"> /u/Faalaafeel </a> <br/> <span><a href="https://www.reddit.com/r/rust/comments/1lm30lj/ide_for_those_using_rustrover_does_linecompletion/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1lm30lj/ide_for_those_using_rustrover_does_linecompletion/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1lm2fog/crossfire_v20_mpmc_channel_for_async_2_times/" target="_blank">Crossfire v2.0: MPMC channel for async, 2 times faster than Flume</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>I have just done crossfire v2.0.0 release, which provides high-performance spsc/mpsc/mpmc channels.</p> <p>It supports async context and can be a bridge between async and blocking contexts.</p> <p>Implemented with lockless in mind, low-level is based on crossbeam-channel.</p> <p>docs: <a href="https://docs.rs/crossfire/2.0.0/crossfire/index.html">https://docs.rs/crossfire/2.0.0/crossfire/index.html</a></p> <p>repo: <a href="https://github.com/frostyplanet/crossfire-rs">https://github.com/frostyplanet/crossfire-rs</a></p> <p>2 years have passed since Crossfire v1.0.0 release. I reviewed the original API and decided that it needs a complete refactor.</p> <p>I heard about Flume, which also supports both async and blocking contexts. I once doubted the necessity of continuing the development of Crossfire. Afterwards, I did some benchmarks and <strong>found our results still very</strong> <strong>competitive</strong>. As more optimization ideas appeared to me, but first, I have to refactor the API, both for better maintenance and easier for users to remember.</p> <p>Rewrote tests and added benchmarks; the results are on the <a href="https://github.com/frostyplanet/crossfire-rs/wiki/benchmark-v2.0-2025%E2%80%9006%E2%80%9027">project wiki</a>.</p> <p>(reddit seams only allow one picture) </p> <p><a href="https://preview.redd.it/07uqztbiqi9f1.png?width=433&amp;format=png&amp;auto=webp&amp;s=4381bad44697daf49b9d437f16eed15be0576a0f">MPMC bounded size 100 async</a></p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/frostyplanet"> /u/frostyplanet </a> <br/> <span><a href="https://www.reddit.com/r/rust/comments/1lm2fog/crossfire_v20_mpmc_channel_for_async_2_times/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1lm2fog/crossfire_v20_mpmc_channel_for_async_2_times/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1lm1hxh/rdfs_raptorq_distributed_file_system_built_in_rust/" target="_blank">RDFS - RaptorQ Distributed File System (built in rust)</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>i post it for the second time.</p> <p>at first people didn&#39;t like AI generated post so i decided to rewrite it again, I written it using AI because of my bad English but in general here it&#39;s.</p> <p>This is uncompleted project aiming to change the (DHT) distributed hash table which is a key-value structure work in distributed system to split the data across multiple nodes for storing large/huge amount of data in nodes storage, something like concatenating all nodes storage into single large one.</p> <p>The second way to make data available is replicated state machine which replicate the data across all nodes something like what big tech compony do in data centers or what decentralized blockchain work, this method will guarantee data availability, in case of attacks like DoS/DDoS attack...etc or even governments would like to shut down all nodes it&#39;s not feasible as all nodes of the system is distributed across the world, also some nodes work behind NAT, Relay or TorVPN so it&#39;s hard to reach from someone out of the system, but this method is waste of storage as all nodes replicate the same data.</p> <p>I have an idea that used in communication and wireless network nowadays, that is using erasure coding mechanism to encode the data into separable parts with extra small redundancy, distribute these parts into different nodes, and then Bow, new we are able to reconstruct the data with threshold number of parts, no matter which parts it&#39;s or which node we got the data from, we only need to accumulate specific number of parts to be able to reconstruct the data again.</p> <p>To make it reliable and optimum i build it in Rust with an additional feature that is building a virtual file system to be able to split the data into data blocks like what we do in normal file system (Ext4, NTFS, APFS ExFAT...etc) under the name of RDFS.</p> <p>This project was build in way to work as a service in the solana blockchain as you could see the program_id field in the super block structure refers to the address of some purchase in the network, But after thinking one more time it will be great if it adapted to work as a new protocol and benifit other without relying in some services using it so I think this structure will be changed soon. </p> <p>i work in this project for maybe 7 days right now, i don&#39;t have the potential to complete as I&#39;m working alone, also i have other stuff to do, maybe somebodies would like to contribute to make it more efficient, general and accessible by other. </p> <p>The repo for more information:<br/> <a href="https://github.com/AhmedBoin/RDFS">https://github.com/AhmedBoin/RDFS</a></p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/Affectionate_Fish194"> /u/Affectionate_Fish194 </a> <br/> <span><a href="https://www.reddit.com/r/rust/comments/1lm1hxh/rdfs_raptorq_distributed_file_system_built_in_rust/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1lm1hxh/rdfs_raptorq_distributed_file_system_built_in_rust/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1lm1f6g/i_made_a_timeout_procmacroattribute_that_wraps/" target="_blank">I made a `#[timeout]` proc-macro-attribute that wraps async functions running under the tokio-runtime, because more often than not (in code that I write) asynchronous functions running too long is an error case, and wrapping/unwrapping them manually is a hassle.</a>
            <div class="item-content">&#32; submitted by &#32; <a href="https://www.reddit.com/user/SuspiciousSegfault"> /u/SuspiciousSegfault </a> <br/> <span><a href="https://github.com/MarcusGrass/timeout">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1lm1f6g/i_made_a_timeout_procmacroattribute_that_wraps/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1llzyty/use_you_webcam_to_connect_to_wifi/" target="_blank">Use you webcam to connect to WiFi.</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>Scan qr-code to connect to WiFi. I learned a little about dbus/zbus along the way. I think zbus isn‚Äôt always the easiest to understand, so maybe having more examples such as this can be useful to others.</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/Traditional_Ebb6557"> /u/Traditional_Ebb6557 </a> <br/> <span><a href="https://github.com/tbro/scampi">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1llzyty/use_you_webcam_to_connect_to_wifi/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1llvud0/the_unreasonable_effectiveness_of_fuzzing_for/" target="_blank">The unreasonable effectiveness of fuzzing for porting programs from C to Rust</a>
            <div class="item-content">&#32; submitted by &#32; <a href="https://www.reddit.com/user/kibwen"> /u/kibwen </a> <br/> <span><a href="https://rjp.io/blog/2025-06-17-unreasonable-effectiveness-of-fuzzing">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1llvud0/the_unreasonable_effectiveness_of_fuzzing_for/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1llvbj3/is_there_a_shift_predictor_for_variable_bitshifts/" target="_blank">Is there a "shift predictor" for variable bitshifts?</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>I have a program that executes variable bitshifts. The shift amounts are always powers of two and are used to compute bit offsets within a packed bitfield. For context, this is for a palette array for a voxel storage engine. </p> <p>(NOTE: ipu=&quot;indices per usize&quot; bpi=&quot;bits per index&quot;)</p> <p>Here&#39;s my first solution, where <code>ipu_mod</code> and <code>bpi_mul</code> are derived from the width of items in the bitfield and replace a modulo and multiplication, respectively. These can&#39;t be constants because the item width is dynamic. <code> let bit_offs = (idx &amp; self.ipu_mod) &lt;&lt; self.bpi_mul; </code></p> <p>In my benchmarks, I find that indexing a pre-computed lookup table is often faster than the bitshift. I utilize this by swapping out <code>bit_offs_table</code> based on the item width. <code> let offs = self.bit_offs_table[idx &amp; self.ipu_mod]; </code></p> <p>This is WAY faster, it improved performance by 25%. Can anybody explain why this is the case? Other bitshifts that have patterns to them don&#39;t suffer this same penalty. I&#39;m on an AMD Ryzen 5 7400U. </p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/RylanStylin57"> /u/RylanStylin57 </a> <br/> <span><a href="https://www.reddit.com/r/rust/comments/1llvbj3/is_there_a_shift_predictor_for_variable_bitshifts/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1llvbj3/is_there_a_shift_predictor_for_variable_bitshifts/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1llssm0/rust_forge_conf_2025_schedule_announced/" target="_blank">Rust Forge Conf 2025 Schedule Announced</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>Kia ora everyone, I&#39;m excited to share an overview of the program that we will have at the inaugural Rust Forge Conf. </p> <p>The conference is being held during the last week of August on Wellington, New Zealand. If you have ever wanted to justify a trip to visit - now is your chance! üòÖ</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/timClicks"> /u/timClicks </a> <br/> <span><a href="https://newsletter.rustforgeconf.com/archive/rust-forge-conf-2025-schedule-available-tours/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1llssm0/rust_forge_conf_2025_schedule_announced/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1llratt/catching_up_with_fastfetch_a_rust_journey/" target="_blank">Catching Up with Fastfetch: A Rust Journey</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><h1>Catching Up with Fastfetch: A Rust Journey</h1> <p>My project, <a href="https://github.com/ahaoboy/neofetch">neofetch</a>, was one of my earliest Rust learning exercises, inspired by <a href="https://github.com/dylanaraps/neofetch">dylanaraps/neofetch</a>, a bash tool designed to display system information. At the time, I didn‚Äôt know how to use msys2 on Windows, so I chose Rust to make it work natively on that platform. This post chronicles my journey of optimizing its performance specifically for Windows.</p> <h2>Initial Implementation: Executing Commands</h2> <p>The initial approach was simple: execute system commands (bash on Unix, PowerShell on Windows), capture their output, parse it with regular expressions, and display the results. For example, to retrieve the OS version on Windows, I used:</p> <p><code>pwsh powershell -c &quot;Get-CimInstance -ClassName Win32_OperatingSystem&quot; </code></p> <p>As a Rust novice, this method was straightforward and functional. Performance wasn‚Äôt a concern‚Äîuntil I encountered <a href="https://github.com/fastfetch-cli/fastfetch">fastfetch</a>. To my surprise, my Rust implementation was slower than the original shell script!</p> <h2>Performance Optimization</h2> <h3>Parallelism with Tokio</h3> <p>After a quick peek at fastfetch‚Äôs code, I set out to improve my project‚Äôs performance. The first version (v0.1.7) was painfully slow, taking about 5 seconds to execute commands serially. My first optimization was to use <a href="https://tokio.rs/">Tokio</a> to run all commands in parallel. In theory, this would reduce the execution time to that of the longest individual task. Sure enough, after integrating Tokio, the time dropped to around 2.5 seconds‚Äîa solid gain, but still sluggish compared to fastfetch‚Äôs 150ms.</p> <h3>Switching to WMI</h3> <p>The bottleneck in parallel tasks often lies in the slowest single task. On Windows, invoking command-line tools carries more overhead than I‚Äôd anticipated. Following fastfetch‚Äôs lead, I turned to lower-level system APIs. I adopted <a href="https://github.com/ohadravid/wmi-rs">WMI</a>, a Rust crate that wraps Windows Management Instrumentation, enabling direct API calls.</p> <p>WMI also supports asynchronous operations, which allowed further speed improvements. For tasks requiring multiple API calls‚Äîsuch as detecting the shell by checking process names‚Äîasync calls proved invaluable. After switching to WMI, the execution time fell to about 500ms. Here‚Äôs a snippet of how I queried the OS version:</p> <p>```rs</p> <h1>[derive(Deserialize, Debug, Clone)]</h1> <h1>[serde(rename = &quot;Win32_OperatingSystem&quot;)]</h1> <p>struct OperatingSystem { #[serde(rename = &quot;Version&quot;)] version: String, } let results: Vec&lt;OperatingSystem&gt; = wmi_query().await?; ```</p> <h3>Going Lower-Level with windows-rs</h3> <p>Still, 500ms wasn‚Äôt fast enough. Rust is often touted as having performance on par with C/C++, which holds true for compute-intensive tasks like calculating Fibonacci numbers or leveraging SIMD for image processing. However, when interacting with a C-based operating system like Windows, Rust typically relies on wrapper libraries unless you resort to <code>unsafe</code> code for direct API calls. These wrappers can introduce overhead.</p> <p>Take, for instance, determining the current shell, as explored in my <a href="https://github.com/ahaoboy/which-shell">which-shell</a> project. This requires fetching the current process ID, name, and parent process ID, then traversing the process tree to identify a known shell. With WMI, this often took three or four calls, each costing around 100ms, making it the most time-consuming task.</p> <p>To address this, I switched to <a href="https://github.com/microsoft/windows-rs">windows-rs</a>, a lower-level crate providing direct access to Windows APIs. Though more complex to use, it delivered a significant performance boost. Paired with Tokio, this brought the execution time down to around 200ms‚Äîfinally comparable to fastfetch. Interestingly, fastfetch offers more features and doesn‚Äôt seem to rely on multithreading (I‚Äôm no C expert, but I didn‚Äôt spot obvious multithreading logic in its code).</p> <p>Here are the benchmark results:</p> <p>``` Benchmark 1: neofetch Time (mean ¬± œÉ): 109.6 ms ¬± 14.8 ms [User: 26.0 ms, System: 110.3 ms] Range (min ‚Ä¶ max): 93.1 ms ‚Ä¶ 143.5 ms 10 runs</p> <p>Benchmark 2: fastfetch Time (mean ¬± œÉ): 127.6 ms ¬± 14.6 ms [User: 42.6 ms, System: 75.9 ms] Range (min ‚Ä¶ max): 105.4 ms ‚Ä¶ 144.7 ms 10 runs</p> <p>Benchmark 3: neofetch-shell Time (mean ¬± œÉ): 1.938 s ¬± 0.089 s [User: 0.495 s, System: 1.181 s] Range (min ‚Ä¶ max): 1.799 s ‚Ä¶ 2.089 s 10 runs</p> <p>Summary neofetch ran 1.16 ¬± 0.21 times faster than fastfetch 17.68 ¬± 2.52 times faster than neofetch-shell ```</p> <p>These figures show that my neofetch now slightly outperforms fastfetch and leaves the original shell-based version in the dust.</p> <h2>Can It Be Faster?</h2> <p>I couldn‚Äôt help but wonder if there was room for even more improvement. To investigate, I created a <a href="https://github.com/ahaoboy/process-info-bench">benchmark project</a> comparing C and Rust implementations of a simple task: calculating the depth of the current process in the process tree.</p> <p>Rust lagged slightly behind C versions compiled with different compilers. Could this be due to residual overhead in <a href="https://github.com/microsoft/windows-rs">windows-rs</a>, despite its low-level nature? Here are the results:</p> <p>``` Benchmark 1: gcc.exe Time (mean ¬± œÉ): 50.4 ms ¬± 4.0 ms [User: 13.0 ms, System: 33.7 ms] Range (min ‚Ä¶ max): 45.9 ms ‚Ä¶ 67.6 ms 54 runs</p> <p>Benchmark 2: g++.exe Time (mean ¬± œÉ): 48.5 ms ¬± 2.0 ms [User: 16.3 ms, System: 27.7 ms] Range (min ‚Ä¶ max): 45.4 ms ‚Ä¶ 54.4 ms 49 runs</p> <p>Benchmark 3: clang.exe Time (mean ¬± œÉ): 48.7 ms ¬± 1.7 ms [User: 15.6 ms, System: 28.5 ms] Range (min ‚Ä¶ max): 45.8 ms ‚Ä¶ 52.9 ms 51 runs</p> <p>Benchmark 4: rust.exe Time (mean ¬± œÉ): 53.3 ms ¬± 2.7 ms [User: 14.1 ms, System: 34.0 ms] Range (min ‚Ä¶ max): 48.7 ms ‚Ä¶ 65.3 ms 48 runs</p> <p>Summary g++.exe ran 1.00 ¬± 0.05 times faster than clang.exe 1.04 ¬± 0.09 times faster than gcc.exe 1.10 ¬± 0.07 times faster than rust.exe ```</p> <p>While Rust comes remarkably close, a small performance gap persists compared to C. This suggests that for certain low-level operations, C may retain a slight edge, possibly due to Rust‚Äôs safety mechanisms or wrapper library overhead.</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/ahaoboy"> /u/ahaoboy </a> <br/> <span><a href="https://www.reddit.com/r/rust/comments/1llratt/catching_up_with_fastfetch_a_rust_journey/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1llratt/catching_up_with_fastfetch_a_rust_journey/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1llo602/a_10chapter_handbook_for_writing_actually_secure/" target="_blank">A 10-chapter handbook for writing actually secure Rust: type-safety, panic-proofing & more.</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>Hey there! I just published a draft of the <strong>Rust Security Handbook</strong> (Markdown only).</p> <p><strong>Covers:</strong> type-level safety, panic-proofing, integer-overflow guards, crypto basics, async pitfalls, and a deploy checklist.</p> <p><strong>GitHub:</strong> <a href="https://github.com/yevh/rust-security-handbook">https://github.com/yevh/rust-security-handbook</a> - feedback or contributions welcome!</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/RiskWise2545"> /u/RiskWise2545 </a> <br/> <span><a href="https://www.reddit.com/r/rust/comments/1llo602/a_10chapter_handbook_for_writing_actually_secure/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1llo602/a_10chapter_handbook_for_writing_actually_secure/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1llmdcy/glowstick_typelevel_tensor_shapes/" target="_blank">Glowstick: type-level tensor shapes</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>Hi <a href="/r/rust">r/rust</a>,</p> <p>I&#39;ve been doing some ML experiments locally in rust (mostly diffusion stuff, distillation &amp; grpo training) and wanted to have the compiler verify tensor dimensions through various operations, so I made this crate <a href="https://github.com/nicksenger/glowstick">glowstick</a>. It uses type-level programming to keep track of the shapes in the type system, so that you can check shapes at compile time, avoid mismatches, etc. Mixing and matching static/dynamic dimensions is also supported, so you can trade safety for flexibility when necessary.</p> <p>I&#39;ve added integrations for the candle and burn frameworks, with example implementations of Llama 3.2 in each. Some folks were also interested in whether these types could be used for optimizations, which wasn&#39;t my original goal. But, it seems like they <em>probably</em> can be - so I added an example of how to specialize some operation for tensors of a certain shape.</p> <p>I hope it&#39;s helpful to some here, and appreciate any feedback. Also, I acknowledge that the code probably looks a bit unusual - so am happy to answer any questions about that as well (and am open to suggestions from those of you more familiar with rust&#39;s trait solver)</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/biet_roi"> /u/biet_roi </a> <br/> <span><a href="https://github.com/nicksenger/glowstick">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1llmdcy/glowstick_typelevel_tensor_shapes/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/rust/comments/1lljcqz/dropin_cargo_replacement_for_offloading_rust/" target="_blank">Drop-in cargo replacement for offloading Rust compilation to a remote server</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>As much as I adore working with large Rust codebases, one daily annoyance I have is the local computational load from executing cargo commands. It slows down dev cycles and keep me tethered to the wall.</p> <p>About 6 months ago, inspired by <code>cargo-remote</code>, I built <code>crunch</code>.</p> <p>My goal for the tool is to have dead-simple devex, as similar as <code>cargo</code> as possible. Just replace <code>cargo</code> with <code>crunch</code>, everything happens as you expect, except the computation happens on a remote server.</p> <p>e.g.</p> <pre><code>crunch check crunch clippy --workspace crunch t -p sys-internals </code></pre> <p>A couple of close devs and I have been using it with a shared Hetzner AX102, and are really enjoying the experience!</p> <p>I know this is a common issue for Rust devs, so figured I&#39;d share.</p> <p>Feedback welcome. Cheers!</p> <p>Repo: <a href="https://github.com/liamaharon/crunch-cli">https://github.com/liamaharon/crunch-cli</a></p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/Ferr3t"> /u/Ferr3t </a> <br/> <span><a href="https://www.reddit.com/r/rust/comments/1lljcqz/dropin_cargo_replacement_for_offloading_rust/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/rust/comments/1lljcqz/dropin_cargo_replacement_for_offloading_rust/">[comments]</a></span></div>
          </li>
  
        </ul>
  
        <h3 class="subreddit">r/golang</h3>
        <ul class="item-list">
  
          <li>
            <a href="https://www.reddit.com/r/golang/comments/1lm8b1a/gozo_v02_is_out_with_composable_streaming/" target="_blank">gozo v0.2 is out with composable streaming</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>Hey <a href="/r/golang">r/golang</a>! I&#39;ve been working on <strong>gozo</strong>, a Go utility library, and just released v0.2 with a major new feature: <strong>composable streaming</strong>.</p> <h1>What&#39;s New</h1> <p>The streams package provides a clean, idiomatic way to build data processing pipelines in Go. Think of it as functional programming meets Go&#39;s simplicity.</p> <p>Here&#39;s a practical HTTP handler that processes JSONEachRow (ndjson) data, filters and transforms it, then writes to both the HTTP response and a database:</p> <pre><code>func handleUserData(w http.ResponseWriter, r *http.Request) { // Create a JSONEachRow reader from request body reader := streams.JSON[User](r.Body) // Filter active users only activeUsers := streams.Filter(reader, func(u User) bool { return u.IsActive }) // Transform to analytics format analytics := streams.Map(activeUsers, func(u User) UserAnalytics { return UserAnalytics{ ID: u.ID, Country: u.Country, JoinDate: u.CreatedAt, Tier: calculateTier(u), } }) dbWriter := NewMyDatabaseWriter[UserAnalytics](db, &quot;user_analytics&quot;) // Process the entire pipeline, write to both HTTP response and database written, err := streams.Multicast(analytics, w, dbWriter) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } log.Printf(&quot;Processed %d records&quot;, written) } </code></pre> <p>The result is a library that feels like writing normal Go code, but with the power of composable data pipelines.</p> <p>Full docs and examples: <a href="https://github.com/sonirico/gozo?tab=readme-ov-file#streams">https://github.com/sonirico/gozo?tab=readme-ov-file#streams</a></p> <p>The library also includes utilities for slices, maps, and functional programming patterns. Would love to hear your thoughts!</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/sonirico"> /u/sonirico </a> <br/> <span><a href="https://github.com/sonirico/gozo?tab=readme-ov-file#streams">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/golang/comments/1lm8b1a/gozo_v02_is_out_with_composable_streaming/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/golang/comments/1llyrnw/ophis_transform_any_cobra_cli_into_an_mcp_server/" target="_blank">Ophis: Transform any Cobra CLI into an MCP server</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>I built a Go library that automatically converts your existing Cobra CLI apps into MCP (Model Context Protocol) servers, letting AI assistants like Claude interact with your tools through structured protocols instead of raw shell access. I have had success turning my own CLIs and other open source CLIs into mcp servers. Here are images showing Claude interacting with my Kubernetes cluster using <a href="https://raw.githubusercontent.com/njayp/host/refs/heads/main/ophis/screenshots/Screenshot%202025-06-27%20at%208.27.45%E2%80%AFAM.png">helm</a> and <a href="https://raw.githubusercontent.com/njayp/host/refs/heads/main/ophis/screenshots/Screenshot%202025-06-27%20at%208.28.44%E2%80%AFAM.png">kubectl</a>. Code <a href="https://github.com/njayp/ophis">here</a>. All criticism is appreciated. Cheers!</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/njayp"> /u/njayp </a> <br/> <span><a href="https://www.reddit.com/r/golang/comments/1llyrnw/ophis_transform_any_cobra_cli_into_an_mcp_server/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/golang/comments/1llyrnw/ophis_transform_any_cobra_cli_into_an_mcp_server/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/golang/comments/1llvdkf/mochi_v0105_a_linqstyle_query_language_with_a/" target="_blank">Mochi v0.10.5: A LINQ-style query language with a bytecode VM written in Go</a>
            <div class="item-content"><table> <tr><td> <a href="https://www.reddit.com/r/golang/comments/1llvdkf/mochi_v0105_a_linqstyle_query_language_with_a/">  </a> </td><td> <!-- SC_OFF --><div class="md"><p>We just released Mochi v0.10.5, a small statically typed language that lets you run SQL-like queries over JSON, CSV, YAML, or in-memory lists, with no database involved. It‚Äôs fully type-checked and compiles to a register-based bytecode VM written in Go.</p> <p>The compiler includes constant folding, dead code elimination, and liveness analysis. It‚Äôs a lightweight way to explore how query engines and interpreters work, and a fun project if you&#39;re into Go, DSLs, or virtual machines. </p> <p>Would love feedback or questions from everyone in the Go community!</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/Adept-Country4317"> /u/Adept-Country4317 </a> <br/> <span><a href="https://github.com/mochilang/mochi/releases/tag/v0.10.5">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/golang/comments/1llvdkf/mochi_v0105_a_linqstyle_query_language_with_a/">[comments]</a></span> </td></tr></table></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/golang/comments/1llrb5c/i_built_a_small_social_network_in_go/" target="_blank">I built a small social network in go</a>
            <div class="item-content"><table> <tr><td> <a href="https://www.reddit.com/r/golang/comments/1llrb5c/i_built_a_small_social_network_in_go/">  </a> </td><td> <!-- SC_OFF --><div class="md"><p>It has messaging, hashtags, global chat with MMO-like isometric visualization of every person in the chat, and support for music/videos/pictures/files both in messages and posts. UI looks good both on desktop and mobile, but it&#39;s rather minimal. Every user has a page where he can post stuff. Also users can follow other users, so their posts will be displayed in their feed. You can also reply to posts. For db I used sqlite and for chats I used gorilla/websocket library. It&#39;s on github under 0BSD License. I also built client in html/js/css which server hosts with http.FileServer. </p> <p>There is a lot of repeated code like code for authorization below in every handler, or similar logic for some requests but I couldn&#39;t figure out a better way that is also simple.</p> <pre><code>err := json.NewDecoder(r.Body).Decode(&amp;a) if err != nil { return jErr } ok := auth(db, a) if !ok { return aErr } </code></pre> <p>The most interesting part to implement was messaging and global chat with web sockets. It first goes in a loop until authorized and then goes to the main loop. When user sends message and server successfully processed it, it sends back signal that everything&#39;s fine so client can display message he just sent. I really like that all functionality is contained in single binary, so I don&#39;t need to install anything on server. There&#39;s even autocert library which automatically generates https certificate.</p> <p>For now each user can only have one session so every time a user logs in, his other session logs out.</p> <p>I have experimented with writing TUI messaging client with bubbletea and it works really nice. I also tried to write messaging client for android but it&#39;s been hard.</p> <p>Feedback would be appreciated.</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/Aggravating_Fault398"> /u/Aggravating_Fault398 </a> <br/> <span><a href="https://github.com/tzrn/minimint">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/golang/comments/1llrb5c/i_built_a_small_social_network_in_go/">[comments]</a></span> </td></tr></table></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/golang/comments/1llr1a6/another_go_variable_dumper_and_interfacetypes/" target="_blank">Another Go variable dumper and interface/types explorer!</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>Hi everyone!</p> <p>I just released a small Go utility library called <a href="https://github.com/janvaclavik/govar"><code>govar</code></a> ‚Äî it&#39;s designed to help you inspect variables and interfaces more easily when debugging or exploring Go code. There are already some similar ones, but I tried to make this one as complete as possible. </p> <p>üîç <strong>What it does:</strong></p> <ul> <li><strong>Dumps Go variables</strong> with structure-aware output </li> <li>Handles nested types, pointers, structs, slices, maps, and more</li> <li>Colorful output | ANSI terminal colors or styled HTML</li> <li>Size &amp; cap info | Shows lengths and capacities</li> <li>Type Methods</li> <li>Customizable</li> <li>Includes a <code>who</code> subpackage for exploring type and interface information</li> </ul> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/mind-crawler"> /u/mind-crawler </a> <br/> <span><a href="https://www.reddit.com/r/golang/comments/1llr1a6/another_go_variable_dumper_and_interfacetypes/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/golang/comments/1llr1a6/another_go_variable_dumper_and_interfacetypes/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/golang/comments/1llpk6x/suggesting_a_slightly_modified_logo_for_the/" target="_blank">Suggesting a slightly modified logo for the subreddit</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>Hey everyone!</p> <p>I noticed that the gopher logo in the subreddit looks a bit weird since the ears of the gopher are cropped due to the circle image. So I fired up gimp and in 512x512px canvas added the gopher with 400px width and aligned it in the center with a y offset of 128. This way when it&#39;s set as a logo in a circle image the center will be the upper part of the gopher, so the eyes/ears. Hope you like it!</p> <p>Check it out on <a href="https://imgur.com/a/D6HqTOj">imgur</a>.</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/steveiliop56"> /u/steveiliop56 </a> <br/> <span><a href="https://www.reddit.com/r/golang/comments/1llpk6x/suggesting_a_slightly_modified_logo_for_the/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/golang/comments/1llpk6x/suggesting_a_slightly_modified_logo_for_the/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/golang/comments/1llomsn/bcl_now_supports_command_execution_in_steps/" target="_blank">[BCL] - Now supports command execution in steps, filter support and many minor changes</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>I&#39;m glad to introduce following features to bcl.<br/> <strong>Features:</strong></p> <ul> <li>Support of filters in tag while unmarshalling to struct. Supported filters: <code>:first, :last, :all, :&lt;nth-position&gt;, :&lt;from&gt;-&lt;to&gt;, :name,&lt;name&gt;</code>. If none filter provided and config has multiple config types, then last config is used.</li> <li>Support of command execution using <code>\</code>@exec`<code>command. It also supports pipeline execution of commands using multiple steps using</code>`@pipeline``.</li> <li>Support of error handling.</li> </ul> <p>Examples:</p> <pre><code> // Pipeline example dir, err = test_error() if (!isNull(err)) { dir = &quot;.&quot; } cmdOutput = { step1 = test(&quot;pipeline step&quot;) step2 = add(10, 20) step3 = (cmd=&quot;echo&quot;, args=[&quot;Pipeline executed&quot;, step1, step2], dir=dir) step1 -&gt; step2 #ArrowNode step2 -&gt; step3 #ArrowNode } package main import ( &quot;fmt&quot; &quot;github.com/oarkflow/bcl&quot; ) type Release struct { PreviousTag string `json:&quot;previous_tag&quot;` Name string `json:&quot;name&quot;` } // Build filter usage in struct tags type Build struct { GoOS string `json:&quot;goos&quot;` GoArch string `json:&quot;goarch&quot;` Output string `json:&quot;output&quot;` Name string `json:&quot;name&quot;` } type BuildConfig struct { ProjectName string `json:&quot;project_name&quot;` DistDir string `json:&quot;dist_dir&quot;` Release []Release `json:&quot;release:all&quot;` Build Build `json:&quot;build:last&quot;` BuildLast Build `json:&quot;build:0&quot;` BuildFirst Build `json:&quot;build:first&quot;` BuildArm Build `json:&quot;build:name,linux-arm64&quot;` Builds []Build `json:&quot;build:0-2&quot;` } func main() { var input = ` project_name = &quot;myapp&quot; dist_dir = &quot;dist&quot; release &quot;v1.3.0&quot; { previous_tag = &quot;v1.2.0&quot; } build &quot;linux-amd64&quot; { goos = &quot;linux&quot; goarch = &quot;amd64&quot; output = &quot;dist/bin/${project_name}-linux-amd64&quot; } build &quot;linux-arm64&quot; { goos = &quot;linux&quot; goarch = &quot;arm64&quot; output = &quot;dist/bin/${project_name}-linux-arm64&quot; } ` var cfg BuildConfig nodes, err := bcl.Unmarshal([]byte(input), &amp;cfg) if err != nil { panic(err) } fmt.Println(&quot;Unmarshalled Config:&quot;) fmt.Printf(&quot;%+v\n\n&quot;, cfg) str := bcl.MarshalAST(nodes) fmt.Println(&quot;Marshaled AST:&quot;) fmt.Println(str) } </code></pre> <p>Repo: <a href="https://github.com/oarkflow/bcl">https://github.com/oarkflow/bcl</a></p> <p>I would highly appreciate your feedback and suggestions.</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/sujitbaniya"> /u/sujitbaniya </a> <br/> <span><a href="https://www.reddit.com/r/golang/comments/1llomsn/bcl_now_supports_command_execution_in_steps/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/golang/comments/1llomsn/bcl_now_supports_command_execution_in_steps/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/golang/comments/1llnlp2/optimizing_godog_bdd_test_execution_in_go_how_to/" target="_blank">Optimizing Godog BDD Test Execution in Go ‚Äì How to Run Scenarios in Parallel?</a>
            <div class="item-content"><!-- SC_OFF --><div class="md"><p>I&#39;m using the Godog BDD framework in Go to run a test suite with around <strong>550+ testcases</strong> spread across multiple <code>.feature</code> files.</p> <p>Currently, the tests run <strong>sequentially</strong> and take about <strong>1 hour</strong> to complete. I&#39;m looking for a way to <strong>parallelize scenario execution</strong> to reduce total runtime, ideally making better use of available CPU cores.</p> <p>I&#39;m aware that <code>go test</code> itself can run in parallel at the package level, but since Godog runs all scenarios within a single test function, it doesn‚Äôt leverage itself. <code>t.Parallel()</code> for each scenario by default.</p> <p><strong>Has anyone successfully implemented true scenario-level parallelism in Godog?</strong></p> <p>Specifically:</p> <ul> <li>Does Godog offer any <strong>built-in support</strong> or pattern for <strong>parallel scenario execution</strong>?</li> <li>Are there community-recommended practices (e.g., worker pools or test runners) to parallelize test scenarios safely?</li> <li>How do you handle <strong>shared setup/cache</strong> like config files, HTTP mocks, or DB connections while keeping scenarios isolated?</li> </ul> <p>Any tips or examples would be much appreciated. Thanks in advance!</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/Available-Lunch-4842"> /u/Available-Lunch-4842 </a> <br/> <span><a href="https://www.reddit.com/r/golang/comments/1llnlp2/optimizing_godog_bdd_test_execution_in_go_how_to/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/golang/comments/1llnlp2/optimizing_godog_bdd_test_execution_in_go_how_to/">[comments]</a></span></div>
          </li>
  
          <li>
            <a href="https://www.reddit.com/r/golang/comments/1lll8ly/i_built_a_social_network_in_go_thoughts/" target="_blank">I built a social network in go. Thoughts?</a>
            <div class="item-content"><table> <tr><td> <a href="https://www.reddit.com/r/golang/comments/1lll8ly/i_built_a_social_network_in_go_thoughts/">  </a> </td><td> <!-- SC_OFF --><div class="md"><p>It has messaging, hashtags, global chat with MMO-like 3D visualization of every person in the chat, and support for music/videos/pictures/files both in messages and posts. For db I used sqlite and for chats I used gorilla/websocket library. It&#39;s on github under 0BSD License. I also built client in html/js/css which server hosts with http.FileServer. UI looks good both on desktop and mobile, but it&#39;s rather minimal. Every user has a pages where he can post stuff. Also users can follow other pages, so their posts with be displayed in his feed. You can also reply to posts.</p> <p>There is a lot of repeated code like code for authorization below in every handler, or similar logic for some requests but I couldn&#39;t figure out a better way that is also simple.</p> <pre><code>err := json.NewDecoder(r.Body).Decode(&amp;a) if err != nil { return jErr } ok := auth(db, a) if !ok { return aErr } </code></pre> <p>The most interesting part to implement was messaging and global chat with web sockets. It first goes in a loop until authorized and then goes to the main loop. When user sends message and server successfully processed it, it sends but that everything&#39;s fine so client can display message he just sent. I really like that all functionality is contained in single binary, so I don&#39;t need to install anything on server. There&#39;s even autocert library which automatically generates https certificate.</p> <p>For now each user can only have one session so every time a user logs in, his other session logs out.</p> <p>I have experimented with writing TUI messaging client with bubbletea and it works really nice. I also tried to write messaging client for android but it&#39;s been hard.</p> <p>Feedback would be appreciated.</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/Main_Analysis_2197"> /u/Main_Analysis_2197 </a> <br/> <span><a href="https://github.com/tzrn/minimint/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/golang/comments/1lll8ly/i_built_a_social_network_in_go_thoughts/">[comments]</a></span> </td></tr></table></div>
          </li>
  
        </ul>
  
      </div>
  
    </div>
  </body>
  </html>